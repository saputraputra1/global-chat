<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Chat Room</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            height: 100vh;
            overflow: hidden;
            color: white;
            touch-action: manipulation;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0 auto;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .auth-container, .chat-container, .profile-container, .messages-container {
            display: none;
            padding: 10px;
            height: 100%;
            width: 100%;
        }

        .auth-container.active, .chat-container.active, .profile-container.active, .messages-container.active {
            display: flex;
            flex-direction: column;
        }

        /* Login/Register Styles */
        .auth-form {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            margin: auto;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ddd;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.3);
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1rem;
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .toggle-auth {
            text-align: center;
            margin-top: 15px;
            color: #ddd;
            font-size: 0.9rem;
        }

        .toggle-auth a {
            color: #4CAF50;
            cursor: pointer;
            text-decoration: none;
        }

        /* Chat Styles */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .chat-header h2 {
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 50%;
        }

        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .users-sidebar {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 200px;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }

        .users-list {
            list-style: none;
            display: flex;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .user-item {
            padding: 8px;
            margin-right: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            position: relative;
            min-width: 200px;
            flex-shrink: 0;
        }

        .user-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .user-item.active {
            background-color: rgba(76, 175, 80, 0.3);
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .online {
            background-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }

        .offline {
            background-color: #f44336;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-info {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        .user-country {
            font-size: 0.7rem;
            color: #aaa;
            display: flex;
            align-items: center;
        }

        .country-flag {
            width: 14px;
            height: 10px;
            margin-right: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .last-seen {
            font-size: 0.7rem;
            color: #aaa;
        }

        .follower-count {
            font-size: 0.6rem;
            color: #4CAF50;
            margin-top: 2px;
        }

        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            animation: messageIn 0.3s ease;
            word-break: break-word;
        }

        .unread {
            background-color: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .message-sender {
            font-weight: bold;
            color: #4CAF50;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.7rem;
            color: #aaa;
            margin-left: 8px;
        }

        .message-content {
            margin-left: 33px;
            font-size: 0.9rem;
        }

        .message-input-container {
            display: flex;
            gap: 8px;
            padding-top: 8px;
            position: sticky;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            padding-bottom: 8px;
        }

        .message-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .message-input:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.3);
        }

        .send-button {
            width: 80px;
            padding: 10px;
        }

        .logout-btn {
            background-color: #f44336;
            width: auto;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background-color: #d32f2f;
        }

        .profile-btn {
            background-color: #2196F3;
            width: auto;
            padding: 6px 10px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .profile-btn:hover {
            background-color: #0b7dda;
        }

        .messages-btn {
            background-color: #9C27B0;
            width: auto;
            padding: 6px 10px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .messages-btn:hover {
            background-color: #7B1FA2;
        }

        .user-actions {
            position: absolute;
            right: 5px;
            top: 5px;
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 18px;
            height: 18px;
            padding: 0;
            font-size: 9px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .block-btn {
            background-color: #ff9800;
        }

        .block-btn:hover {
            background-color: #e68a00;
        }

        .delete-btn {
            background-color: #f44336;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .follow-btn {
            background-color: #4CAF50;
        }

        .follow-btn:hover {
            background-color: #45a049;
        }

        .unfollow-btn {
            background-color: #f44336;
        }

        .unfollow-btn:hover {
            background-color: #d32f2f;
        }

        .profile-view {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: none;
            overflow-y: auto;
            max-height: 40%;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .profile-details {
            flex: 1;
        }

        .profile-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .profile-country {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .profile-country-flag {
            width: 16px;
            height: 12px;
            margin-right: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .profile-description {
            font-size: 0.8rem;
            color: #ddd;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .profile-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 5px;
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-weight: bold;
            color: #4CAF50;
            font-size: 0.9rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #aaa;
        }

        .profile-status {
            font-size: 0.7rem;
            color: #aaa;
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        /* Message Management Styles */
        .messages-management {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .messages-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .messages-tab.active {
            border-bottom: 2px solid #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .messages-tab:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .messages-content {
            flex: 1;
            overflow-y: auto;
        }

        .messages-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .messages-table th, .messages-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .messages-table th {
            background-color: rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            font-size: 0.8rem;
        }

        .messages-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .unread-message {
            font-weight: bold;
        }

        .message-row {
            cursor: pointer;
        }

        .message-row:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .message-user {
            display: flex;
            align-items: center;
        }

        .message-avatar-small {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Admin ban controls */
        .ban-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .ban-btn {
            background-color: #ff9800;
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .ban-btn:hover {
            background-color: #e68a00;
        }

        .permanent-ban-btn {
            background-color: #f44336;
        }

        .permanent-ban-btn:hover {
            background-color: #d32f2f;
        }

        .unban-btn {
            background-color: #4CAF50;
        }

        .unban-btn:hover {
            background-color: #45a049;
        }

        /* Floating bubbles animation */
        .bubbles {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            top: 0;
            left: 0;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: rise 10s infinite ease-in;
        }

        .bubble:nth-child(1) {
            width: 30px;
            height: 30px;
            left: 10%;
            animation-duration: 8s;
        }

        .bubble:nth-child(2) {
            width: 15px;
            height: 15px;
            left: 20%;
            animation-duration: 5s;
            animation-delay: 1s;
        }

        .bubble:nth-child(3) {
            width: 40px;
            height: 40px;
            left: 35%;
            animation-duration: 7s;
            animation-delay: 2s;
        }

        .bubble:nth-child(4) {
            width: 60px;
            height: 60px;
            left: 50%;
            animation-duration: 11s;
            animation-delay: 0s;
        }

        .bubble:nth-child(5) {
            width: 25px;
            height: 25px;
            left: 55%;
            animation-duration: 6s;
            animation-delay: 1s;
        }

        .bubble:nth-child(6) {
            width: 35px;
            height: 35px;
            left: 65%;
            animation-duration: 8s;
            animation-delay: 3s;
        }

        .bubble:nth-child(7) {
            width: 20px;
            height: 20px;
            left: 75%;
            animation-duration: 7s;
            animation-delay: 2s;
        }

        .bubble:nth-child(8) {
            width: 60px;
            height: 60px;
            left: 80%;
            animation-duration: 6s;
            animation-delay: 1s;
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                transform: translateX(0);
            }
            50% {
                transform: translateX(100px);
            }
            100% {
                bottom: 1080px;
                transform: translateX(-200px);
            }
        }

        /* Profile form styles */
        .profile-form {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            margin: auto;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
            overflow-y: auto;
            max-height: 90%;
        }

        .avatar-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .avatar-upload-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .avatar-upload-btn:hover {
            background-color: #0b7dda;
        }

        #avatar-upload-input {
            display: none;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }

        .readonly-field {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: #aaa !important;
            cursor: not-allowed !important;
        }

        /* Translate button */
        .translate-btn {
            background-color: #FF9800;
            width: auto;
            padding: 6px 10px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .translate-btn:hover {
            background-color: #e68a00;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* New Chat Controls Styles */
        .chat-controls {
            display: flex;
            flex-direction: column;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-title {
            font-size: 0.9rem;
            color: #4CAF50;
            font-weight: bold;
            margin-right: 10px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-btn i {
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .control-btn.active {
            background-color: #4CAF50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .user-search {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .user-search:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .chat-main {
                flex-direction: row;
            }
            
            .users-sidebar {
                width: 250px;
                max-height: none;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                border-bottom: none;
            }
            
            .users-list {
                display: flex;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            
            .user-item {
                margin-right: 8px;
                margin-bottom: 0;
                min-width: 200px;
                flex-shrink: 0;
            }
            
            .profile-view {
                max-height: none;
            }

            .chat-controls {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .control-row {
                margin-bottom: 0;
                margin-right: 15px;
            }

            .control-row:last-child {
                margin-right: 0;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Pulse animation for online users */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .online.pulse {
            animation: pulse 2s infinite;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Background bubbles animation -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <div class="container">
        <!-- Authentication Container -->
        <div id="auth-container" class="auth-container active">
            <div id="login-form" class="auth-form">
                <h2>Login to Global Chat</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <button id="login-btn">Login</button>
                <div class="toggle-auth">
                    Don't have an account? <a id="show-register">Register</a>
                </div>
            </div>

            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register for Global Chat</h2>
                <div class="form-group">
                    <label for="register-username">Username</label>
                    <input type="text" id="register-username" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="register-gender">Jenis Kelamin</label>
                    <select id="register-gender">
                        <option value="">Pilih Jenis Kelamin</option>
                        <option value="male">Pria</option>
                        <option value="female">Wanita</option>
                        <option value="other">Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-country">Country</label>
                    <input type="text" id="register-country" class="readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="register-timezone">Timezone</label>
                    <input type="text" id="register-timezone" class="readonly-field" readonly>
                </div>
                <div id="location-fields-indonesia" style="display: none;">
                    <div class="form-group">
                        <label for="register-province">Province</label>
                        <input type="text" id="register-province" class="readonly-field" readonly>
                    </div>
                    <div class="form-group">
                        <label for="register-city">City/Regency</label>
                        <input type="text" id="register-city" class="readonly-field" readonly>
                    </div>
                </div>
                <div id="location-fields-other" style="display: none;">
                    <div class="form-group">
                        <label for="register-city-other">City</label>
                        <input type="text" id="register-city-other" class="readonly-field" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-description">Profile Description</label>
                    <textarea id="register-description" placeholder="Tell others about yourself"></textarea>
                </div>
                <div class="avatar-upload-container">
                    <img id="register-avatar-preview" class="avatar-preview" src="" alt="Profile Picture">
                    <label for="register-avatar-upload" class="avatar-upload-btn">Choose Profile Picture</label>
                    <input type="file" id="register-avatar-upload" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="face-verification-btn" class="avatar-upload-btn">Face Verification</label>
                    <button id="face-verification-btn" style="display: none;"></button>
                    <video id="face-verification-video" width="320" height="240" autoplay style="display: none;"></video>
                    <canvas id="face-verification-canvas" width="320" height="240" style="display: none;"></canvas>
                </div>
                <button id="register-btn">Register</button>
                <div class="toggle-auth">
                    Already have an account? <a id="show-login">Login</a>
                </div>
            </div>
        </div>

        <!-- Leaderboard Container -->
        <div id="leaderboard-container" class="profile-container" style="display: none;">
            <div class="profile-form">
                <h2>Leaderboard</h2>
                <div class="form-actions">
                    <button id="sort-by-followers-btn" class="profile-btn">Sort by Followers</button>
                    <button id="sort-by-reply-btn" class="profile-btn">Sort by Reply %</button>
                </div>
                <table class="messages-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Followers</th>
                            <th>Reply %</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-list"></tbody>
                </table>
                <div class="form-actions">
                    <button id="back-to-chat-from-leaderboard-btn" class="logout-btn">Back to Chat</button>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="chat-container">
            <div class="chat-header">
                <h2>Global Chat Room</h2>
                <div class="header-buttons">
                    <button id="profile-btn" class="profile-btn tooltip">
                        <i class="fas fa-user"></i>
                        <span class="tooltiptext">Profile</span>
                    </button>
                </div>
            </div>
            
            <div class="chat-controls">
                <div class="control-row">
                    <span class="control-title">Online Users</span>
                    <input type="text" id="user-search" class="user-search" placeholder="Search users...">
                    <select id="country-filter" class="user-search">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="control-row">
                    <span class="control-title">Actions</span>
                    <div class="control-buttons">
                        <button id="refresh-users" class="control-btn tooltip">
                            <i class="fas fa-sync-alt"></i>
                            <span class="tooltiptext">Refresh Users</span>
                        </button>
                        <button id="filter-online" class="control-btn active tooltip">
                            <i class="fas fa-circle"></i> Online
                            <span class="tooltiptext">Show Online Only</span>
                        </button>
                        <button id="filter-all" class="control-btn tooltip">
                            <i class="fas fa-users"></i> All
                            <span class="tooltiptext">Show All Users</span>
                        </button>
                        <button id="translate-btn" class="control-btn tooltip">
                            <i class="fas fa-language"></i>
                            <span class="tooltiptext">Toggle Translation</span>
                        </button>
                        <button id="messages-btn" class="control-btn tooltip">
                            <i class="fas fa-envelope"></i>
                            <span class="tooltiptext">Messages</span>
                        </button>
                        <button id="logout-btn" class="control-btn logout-btn tooltip">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="tooltiptext">Logout</span>
                        </button>
                        <button id="leaderboard-btn" class="control-btn tooltip">
                            <i class="fas fa-trophy"></i>
                            <span class="tooltiptext">Leaderboard</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="chat-main">
                <div class="users-sidebar">
                    <ul id="users-list" class="users-list"></ul>
                </div>
                <div class="chat-area">
                    <div id="profile-view" class="profile-view">
                        <div class="profile-header">
                            <img id="view-profile-avatar" class="profile-avatar" src="" alt="Profile Picture">
                            <div class="profile-details">
                                <div class="profile-name" id="view-profile-name"></div>
                                <div class="profile-country" id="view-profile-country"></div>
                                <div class="profile-status" id="view-profile-status"></div>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="followers-count">0</div>
                                <div class="stat-label">Followers</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="following-count">0</div>
                                <div class="stat-label">Following</div>
                            </div>
                        </div>
                        <div class="profile-description" id="view-profile-description"></div>
                        <div class="profile-actions">
                            <button id="follow-btn" class="follow-btn" style="display: none;">
                                <i class="fas fa-user-plus"></i> Follow
                            </button>
                            <button id="unfollow-btn" class="unfollow-btn" style="display: none;">
                                <i class="fas fa-user-minus"></i> Unfollow
                            </button>
                        </div>
                        <div id="admin-controls" class="ban-controls" style="display: none;">
                            <button id="temp-ban-btn" class="ban-btn">
                                <i class="fas fa-clock"></i> Temporary Ban
                            </button>
                            <button id="perm-ban-btn" class="ban-btn permanent-ban-btn">
                                <i class="fas fa-ban"></i> Permanent Ban
                            </button>
                            <button id="unban-btn" class="ban-btn unban-btn">
                                <i class="fas fa-check-circle"></i> Unban User
                            </button>
                        </div>
                    </div>
                    <div id="chat-messages-container" class="chat-messages-container"></div>
                    <div class="message-input-container">
                        <input type="text" id="message-input" class="message-input" placeholder="Type your message...">
                        <button id="send-btn" class="send-button">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Container -->
        <div id="profile-container" class="profile-container">
            <div class="profile-form">
                <h2>Edit Profile</h2>
                <div class="avatar-upload-container">
                    <img id="profile-avatar-preview" class="avatar-preview" src="" alt="Profile Picture">
                    <label for="profile-avatar-upload" class="avatar-upload-btn">Change Profile Picture</label>
                    <input type="file" id="profile-avatar-upload" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="profile-username">Username</label>
                    <input type="text" id="profile-username" placeholder="Your username" class="readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="profile-country">Country</label>
                    <select id="profile-country" class="readonly-field" disabled>
                        <option value="">Select your country</option>
                        <!-- Countries will be populated but disabled -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="profile-description">Profile Description</label>
                    <textarea id="profile-description" placeholder="Tell others about yourself"></textarea>
                </div>
                <div class="form-actions">
                    <button id="save-profile-btn" class="profile-btn">
                        <i class="fas fa-save"></i> Save Profile
                    </button>
                    <button id="cancel-profile-btn" class="logout-btn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Management Container -->
        <div id="messages-container" class="messages-container">
            <div class="chat-header">
                <h2>Message Management</h2>
                <div>
                    <button id="back-to-chat-btn" class="profile-btn">
                        <i class="fas fa-arrow-left"></i> Back to Chat
                    </button>
                </div>
            </div>
            <div class="messages-management">
                <div class="messages-tabs">
                    <div class="messages-tab active" data-tab="all">
                        <i class="fas fa-inbox"></i> All Messages
                    </div>
                    <div class="messages-tab" data-tab="unread">
                        <i class="fas fa-envelope"></i> Unread Messages
                    </div>
                    <div class="messages-tab" data-tab="following">
                        <i class="fas fa-user-friends"></i> Following
                    </div>
                </div>
                <div class="messages-content">
                    <div id="all-messages-tab" class="messages-tab-content">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Message</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="all-messages-list"></tbody>
                        </table>
                    </div>
                    <div id="unread-messages-tab" class="messages-tab-content" style="display: none;">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Message</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="unread-messages-list"></tbody>
                        </table>
                    </div>
                    <div id="following-tab" class="messages-tab-content" style="display: none;">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Followers</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="following-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQVIvZvxmYdcriHR8j0ormGzNRjGD0_no",
            authDomain: "online--suit.firebaseapp.com",
            databaseURL: "https://online--suit-default-rtdb.firebaseio.com",
            projectId: "online--suit",
            storageBucket: "online--suit.firebasestorage.app",
            messagingSenderId: "463840835705",
            appId: "1:463840835705:web:f490fd49851c0afb8dfca8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const profileContainer = document.getElementById('profile-container');
        const messagesContainer = document.getElementById('messages-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const messagesBtn = document.getElementById('messages-btn');
        const translateBtn = document.getElementById('translate-btn');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelProfileBtn = document.getElementById('cancel-profile-btn');
        const usersList = document.getElementById('users-list');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const profileView = document.getElementById('profile-view');
        const viewProfileName = document.getElementById('view-profile-name');
        const viewProfileAvatar = document.getElementById('view-profile-avatar');
        const viewProfileCountry = document.getElementById('view-profile-country');
        const viewProfileDescription = document.getElementById('view-profile-description');
        const viewProfileStatus = document.getElementById('view-profile-status');
        const followersCount = document.getElementById('followers-count');
        const followingCount = document.getElementById('following-count');
        const followBtn = document.getElementById('follow-btn');
        const unfollowBtn = document.getElementById('unfollow-btn');
        const allMessagesList = document.getElementById('all-messages-list');
        const unreadMessagesList = document.getElementById('unread-messages-list');
        const followingList = document.getElementById('following-list');
        const messageTabs = document.querySelectorAll('.messages-tab');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const profileAvatarUpload = document.getElementById('profile-avatar-upload');
        const registerAvatarPreview = document.getElementById('register-avatar-preview');
        const registerAvatarUpload = document.getElementById('register-avatar-upload');
        const tempBanBtn = document.getElementById('temp-ban-btn');
        const permBanBtn = document.getElementById('perm-ban-btn');
        const unbanBtn = document.getElementById('unban-btn');
        const adminControls = document.getElementById('admin-controls');
        const userSearch = document.getElementById('user-search');
        const countryFilter = document.getElementById('country-filter');
        const refreshUsersBtn = document.getElementById('refresh-users');
        const filterOnlineBtn = document.getElementById('filter-online');
        const filterAllBtn = document.getElementById('filter-all');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const backToChatFromLeaderboardBtn = document.getElementById('back-to-chat-from-leaderboard-btn');

        // Current user data
        let currentUser = null;
        let currentChatWith = null;
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let unreadMessages = {};
        let messageListeners = {};
        let userListeners = {};
        let followListeners = {};
        let selectedAvatarFile = null;
        let translateEnabled = false;
        let targetLanguage = 'en'; // Default to English
        let allMessagesListener = null;
        let unreadMessagesListener = null;
        let followingListener = null;
        let isAdmin = false; // Flag to check if current user is admin
        const adminEmails = ['admin@example.com']; // List of admin emails
        let showOnlineOnly = true; // Default to show online users only

        // Deep Translate API configuration
        const translateApiUrl = 'https://deep-translate1.p.rapidapi.com/language/translate/v2';
        const translateApiKey = '33c2cafafdmsh8fa0dd9b930f308p112f4';
        const translateApiHost = 'deep-translate1.p.rapidapi.com';

        // Face++ API configuration
        const facePlusPlusApiKey = '0C3FblpT0a0j4y5sCjYPP_Gde89c-5P-';
        const facePlusPlusApiSecret = '1sEoNnK2A_Yk5a-t8n5f_HylH5E2fXyQ';
        const facePlusPlusApiUrl = 'https://api-us.faceplusplus.com/facepp/v3/detect';

        // Country flag mapping (using emoji flags)
        const countryFlags = {
            'af': '🇦🇫', 'al': '🇦🇱', 'dz': '🇩🇿', 'as': '🇦🇸', 'ad': '🇦🇩', 'ao': '🇦🇴', 'ai': '🇦🇮', 'aq': '🇦🇶', 
            'ag': '🇦🇬', 'ar': '🇦🇷', 'am': '🇦🇲', 'aw': '🇦🇼', 'au': '🇦🇺', 'at': '🇦🇹', 'az': '🇦🇿', 'bs': '🇧🇸', 
            'bh': '🇧🇭', 'bd': '🇧🇩', 'bb': '🇧🇧', 'by': '🇧🇾', 'be': '🇧🇪', 'bz': '🇧🇿', 'bj': '🇧🇯', 'bm': '🇧🇲', 
            'bt': '🇧🇹', 'bo': '🇧🇴', 'ba': '🇧🇦', 'bw': '🇧🇼', 'br': '🇧🇷', 'io': '🇮🇴', 'vg': '🇻🇬', 'bn': '🇧🇳', 
            'bg': '🇧🇬', 'bf': '🇧🇫', 'bi': '🇧🇮', 'kh': '🇰🇭', 'cm': '🇨🇲', 'ca': '🇨🇦', 'cv': '🇨🇻', 'ky': '🇰🇾', 
            'cf': '🇨🇫', 'td': '🇹🇩', 'cl': '🇨🇱', 'cn': '🇨🇳', 'cx': '🇨🇽', 'cc': '🇨🇨', 'co': '🇨🇴', 'km': '🇰🇲', 
            'ck': '🇨🇰', 'cr': '🇨🇷', 'hr': '🇭🇷', 'cu': '🇨🇺', 'cw': '🇨🇼', 'cy': '🇨🇾', 'cz': '🇨🇿', 'cd': '🇨🇩', 
            'dk': '🇩🇰', 'dj': '🇩🇯', 'dm': '🇩🇲', 'do': '🇩🇴', 'tl': '🇹🇱', 'ec': '🇪🇨', 'eg': '🇪🇬', 'sv': '🇸🇻', 
            'gq': '🇬🇶', 'er': '🇪🇷', 'ee': '🇪🇪', 'et': '🇪🇹', 'fk': '🇫🇰', 'fo': '🇫🇴', 'fj': '🇫🇯', 'fi': '🇫🇮', 
            'fr': '🇫🇷', 'pf': '🇵🇫', 'ga': '🇬🇦', 'gm': '🇬🇲', 'ge': '🇬🇪', 'de': '🇩🇪', 'gh': '🇬🇭', 'gi': '🇬🇮', 
            'gr': '🇬🇷', 'gl': '🇬🇱', 'gd': '🇬🇩', 'gu': '🇬🇺', 'gt': '🇬🇹', 'gg': '🇬🇬', 'gn': '🇬🇳', 'gw': '🇬🇼', 
            'gy': '🇬🇾', 'ht': '🇭🇹', 'hn': '🇭🇳', 'hk': '🇭🇰', 'hu': '🇭🇺', 'is': '🇮🇸', 'in': '🇮🇳', 'id': '🇮🇩', 
            'ir': '🇮🇷', 'iq': '🇮🇶', 'ie': '🇮🇪', 'im': '🇮🇲', 'il': '🇮🇱', 'it': '🇮🇹', 'ci': '🇨🇮', 'jm': '🇯🇲', 
            'jp': '🇯🇵', 'je': '🇯🇪', 'jo': '🇯🇴', 'kz': '🇰🇿', 'ke': '🇰🇪', 'ki': '🇰🇮', 'xk': '🇽🇰', 'kw': '🇰🇼', 
            'kg': '🇰🇬', 'la': '🇱🇦', 'lv': '🇱🇻', 'lb': '🇱🇧', 'ls': '🇱🇸', 'lr': '🇱🇷', 'ly': '🇱🇾', 'li': '🇱🇮', 
            'lt': '🇱🇹', 'lu': '🇱🇺', 'mo': '🇲🇴', 'mk': '🇲🇰', 'mg': '🇲🇬', 'mw': '🇲🇼', 'my': '🇲🇾', 'mv': '🇲🇻', 
            'ml': '🇲🇱', 'mt': '🇲🇹', 'mh': '🇲🇭', 'mr': '🇲🇷', 'mu': '🇲🇺', 'yt': '🇾🇹', 'mx': '🇲🇽', 'fm': '🇫🇲', 
            'md': '🇲🇩', 'mc': '🇲🇨', 'mn': '🇲🇳', 'me': '🇲🇪', 'ms': '🇲🇸', 'ma': '🇲🇦', 'mz': '🇲🇿', 'mm': '🇲🇲', 
            'na': '🇳🇦', 'nr': '🇳🇷', 'np': '🇳🇵', 'nl': '🇳🇱', 'an': '🇳🇱', 'nc': '🇳🇨', 'nz': '🇳🇿', 'ni': '🇳🇮', 
            'ne': '🇳🇪', 'ng': '🇳🇬', 'nu': '🇳🇺', 'kp': '🇰🇵', 'mp': '🇲🇵', 'no': '🇳🇴', 'om': '🇴🇲', 'pk': '🇵🇰', 
            'pw': '🇵🇼', 'ps': '🇵🇸', 'pa': '🇵🇦', 'pg': '🇵🇬', 'py': '🇵🇾', 'pe': '🇵🇪', 'ph': '🇵🇭', 'pn': '🇵🇳', 
            'pl': '🇵🇱', 'pt': '🇵🇹', 'pr': '🇵🇷', 'qa': '🇶🇦', 'cg': '🇨🇬', 're': '🇷🇪', 'ro': '🇷🇴', 'ru': '🇷🇺', 
            'rw': '🇷🇼', 'bl': '🇧🇱', 'sh': '🇸🇭', 'kn': '🇰🇳', 'lc': '🇱🇨', 'mf': '🇲🇫', 'pm': '🇵🇲', 'vc': '🇻🇨', 
            'ws': '🇼🇸', 'sm': '🇸🇲', 'st': '🇸🇹', 'sa': '🇸🇦', 'sn': '🇸🇳', 'rs': '🇷🇸', 'sc': '🇸🇨', 'sl': '🇸🇱', 
            'sg': '🇸🇬', 'sx': '🇸🇽', 'sk': '🇸🇰', 'si': '🇸🇮', 'sb': '🇸🇧', 'so': '🇸🇴', 'za': '🇿🇦', 'kr': '🇰🇷', 
            'ss': '🇸🇸', 'es': '🇪🇸', 'lk': '🇱🇰', 'sd': '🇸🇩', 'sr': '🇸🇷', 'sj': '🇸🇯', 'sz': '🇸🇿', 'se': '🇸🇪', 
            'ch': '🇨🇭', 'sy': '🇸🇾', 'tw': '🇹🇼', 'tj': '🇹🇯', 'tz': '🇹🇿', 'th': '🇹🇭', 'tg': '🇹🇬', 'tk': '🇹🇰', 
            'to': '🇹🇴', 'tt': '🇹🇹', 'tn': '🇹🇳', 'tr': '🇹🇷', 'tm': '🇹🇲', 'tc': '🇹🇨', 'tv': '🇹🇻', 'vi': '🇻🇮', 
            'ug': '🇺🇬', 'ua': '🇺🇦', 'ae': '🇦🇪', 'gb': '🇬🇧', 'us': '🇺🇸', 'uy': '🇺🇾', 'uz': '🇺🇿', 'vu': '🇻🇺', 
            'va': '🇻🇦', 've': '🇻🇪', 'vn': '🇻🇳', 'wf': '🇼🇫', 'eh': '🇪🇭', 'ye': '🇾🇪', 'zm': '🇿🇲', 'zw': '🇿🇼',
            'other': '🌍'
        };

        // Country name mapping (complete list)
        const countryNames = {
            'af': 'Afghanistan', 'al': 'Albania', 'dz': 'Algeria', 'as': 'American Samoa', 'ad': 'Andorra', 
            'ao': 'Angola', 'ai': 'Anguilla', 'aq': 'Antarctica', 'ag': 'Antigua and Barbuda', 'ar': 'Argentina', 
            'am': 'Armenia', 'aw': 'Aruba', 'au': 'Australia', 'at': 'Austria', 'az': 'Azerbaijan', 'bs': 'Bahamas', 
            'bh': 'Bahrain', 'bd': 'Bangladesh', 'bb': 'Barbados', 'by': 'Belarus', 'be': 'Belgium', 'bz': 'Belize', 
            'bj': 'Benin', 'bm': 'Bermuda', 'bt': 'Bhutan', 'bo': 'Bolivia', 'ba': 'Bosnia and Herzegovina', 
            'bw': 'Botswana', 'br': 'Brazil', 'io': 'British Indian Ocean Territory', 'vg': 'British Virgin Islands', 
            'bn': 'Brunei', 'bg': 'Bulgaria', 'bf': 'Burkina Faso', 'bi': 'Burundi', 'kh': 'Cambodia', 'cm': 'Cameroon', 
            'ca': 'Canada', 'cv': 'Cape Verde', 'ky': 'Cayman Islands', 'cf': 'Central African Republic', 'td': 'Chad', 
            'cl': 'Chile', 'cn': 'China', 'cx': 'Christmas Island', 'cc': 'Cocos Islands', 'co': 'Colombia', 
            'km': 'Comoros', 'ck': 'Cook Islands', 'cr': 'Costa Rica', 'hr': 'Croatia', 'cu': 'Cuba', 'cw': 'Curacao', 
            'cy': 'Cyprus', 'cz': 'Czech Republic', 'cd': 'Democratic Republic of the Congo', 'dk': 'Denmark', 
            'dj': 'Djibouti', 'dm': 'Dominica', 'do': 'Dominican Republic', 'tl': 'East Timor', 'ec': 'Ecuador', 
            'eg': 'Egypt', 'sv': 'El Salvador', 'gq': 'Equatorial Guinea', 'er': 'Eritrea', 'ee': 'Estonia', 
            'et': 'Ethiopia', 'fk': 'Falkland Islands', 'fo': 'Faroe Islands', 'fj': 'Fiji', 'fi': 'Finland', 
            'fr': 'France', 'pf': 'French Polynesia', 'ga': 'Gabon', 'gm': 'Gambia', 'ge': 'Georgia', 'de': 'Germany', 
            'gh': 'Ghana', 'gi': 'Gibraltar', 'gr': 'Greece', 'gl': 'Greenland', 'gd': 'Grenada', 'gu': 'Guam', 
            'gt': 'Guatemala', 'gg': 'Guernsey', 'gn': 'Guinea', 'gw': 'Guinea-Bissau', 'gy': 'Guyana', 'ht': 'Haiti', 
            'hn': 'Honduras', 'hk': 'Hong Kong', 'hu': 'Hungary', 'is': 'Iceland', 'in': 'India', 'id': 'Indonesia', 
            'ir': 'Iran', 'iq': 'Iraq', 'ie': 'Ireland', 'im': 'Isle of Man', 'il': 'Israel', 'it': 'Italy', 
            'ci': 'Ivory Coast', 'jm': 'Jamaica', 'jp': 'Japan', 'je': 'Jersey', 'jo': 'Jordan', 'kz': 'Kazakhstan', 
            'ke': 'Kenya', 'ki': 'Kiribati', 'xk': 'Kosovo', 'kw': 'Kuwait', 'kg': 'Kyrgyzstan', 'la': 'Laos', 
            'lv': 'Latvia', 'lb': 'Lebanon', 'ls': 'Lesotho', 'lr': 'Liberia', 'ly': 'Libya', 'li': 'Liechtenstein', 
            'lt': 'Lithuania', 'lu': 'Luxembourg', 'mo': 'Macau', 'mk': 'Macedonia', 'mg': 'Madagascar', 
            'mw': 'Malawi', 'my': 'Malaysia', 'mv': 'Maldives', 'ml': 'Mali', 'mt': 'Malta', 'mh': 'Marshall Islands', 
            'mr': 'Mauritania', 'mu': 'Mauritius', 'yt': 'Mayotte', 'mx': 'Mexico', 'fm': 'Micronesia', 'md': 'Moldova', 
            'mc': 'Monaco', 'mn': 'Mongolia', 'me': 'Montenegro', 'ms': 'Montserrat', 'ma': 'Morocco', 'mz': 'Mozambique', 
            'mm': 'Myanmar', 'na': 'Namibia', 'nr': 'Nauru', 'np': 'Nepal', 'nl': 'Netherlands', 'an': 'Netherlands Antilles', 
            'nc': 'New Caledonia', 'nz': 'New Zealand', 'ni': 'Nicaragua', 'ne': 'Niger', 'ng': 'Nigeria', 'nu': 'Niue', 
            'kp': 'North Korea', 'mp': 'Northern Mariana Islands', 'no': 'Norway', 'om': 'Oman', 'pk': 'Pakistan', 
            'pw': 'Palau', 'ps': 'Palestine', 'pa': 'Panama', 'pg': 'Papua New Guinea', 'py': 'Paraguay', 'pe': 'Peru', 
            'ph': 'Philippines', 'pn': 'Pitcairn', 'pl': 'Poland', 'pt': 'Portugal', 'pr': 'Puerto Rico', 'qa': 'Qatar', 
            'cg': 'Republic of the Congo', 're': 'Reunion', 'ro': 'Romania', 'ru': 'Russia', 'rw': 'Rwanda', 
            'bl': 'Saint Barthelemy', 'sh': 'Saint Helena', 'kn': 'Saint Kitts and Nevis', 'lc': 'Saint Lucia', 
            'mf': 'Saint Martin', 'pm': 'Saint Pierre and Miquelon', 'vc': 'Saint Vincent and the Grenadines', 
            'ws': 'Samoa', 'sm': 'San Marino', 'st': 'Sao Tome and Principe', 'sa': 'Saudi Arabia', 'sn': 'Senegal', 
            'rs': 'Serbia', 'sc': 'Seychelles', 'sl': 'Sierra Leone', 'sg': 'Singapore', 'sx': 'Sint Maarten', 
            'sk': 'Slovakia', 'si': 'Slovenia', 'sb': 'Solomon Islands', 'so': 'Somalia', 'za': 'South Africa', 
            'kr': 'South Korea', 'ss': 'South Sudan', 'es': 'Spain', 'lk': 'Sri Lanka', 'sd': 'Sudan', 'sr': 'Suriname', 
            'sj': 'Svalbard and Jan Mayen', 'sz': 'Swaziland', 'se': 'Sweden', 'ch': 'Switzerland', 'sy': 'Syria', 
            'tw': 'Taiwan', 'tj': 'Tajikistan', 'tz': 'Tanzania', 'th': 'Thailand', 'tg': 'Togo', 'tk': 'Tokelau', 
            'to': 'Tonga', 'tt': 'Trinidad and Tobago', 'tn': 'Tunisia', 'tr': 'Turkey', 'tm': 'Turkmenistan', 
            'tc': 'Turks and Caicos Islands', 'tv': 'Tuvalu', 'vi': 'U.S. Virgin Islands', 'ug': 'Uganda', 
            'ua': 'Ukraine', 'ae': 'United Arab Emirates', 'gb': 'United Kingdom', 'us': 'United States', 
            'uy': 'Uruguay', 'uz': 'Uzbekistan', 'vu': 'Vanuatu', 'va': 'Vatican', 've': 'Venezuela', 'vn': 'Vietnam', 
            'wf': 'Wallis and Futuna', 'eh': 'Western Sahara', 'ye': 'Yemen', 'zm': 'Zambia', 'zw': 'Zimbabwe',
            'other': 'Other Country'
        };

        // Language codes mapping for Deep Translate API
        const languageCodes = {
            'af': 'af', 'al': 'sq', 'dz': 'ar', 'as': 'en', 'ad': 'ca', 'ao': 'pt', 'ai': 'en', 'aq': 'en', 
            'ag': 'en', 'ar': 'es', 'am': 'hy', 'aw': 'nl', 'au': 'en', 'at': 'de', 'az': 'az', 'bs': 'bs', 
            'bh': 'ar', 'bd': 'bn', 'bb': 'en', 'by': 'be', 'be': 'nl', 'bz': 'en', 'bj': 'fr', 'bm': 'en', 
            'bt': 'dz', 'bo': 'es', 'ba': 'bs', 'bw': 'en', 'br': 'pt', 'io': 'en', 'vg': 'en', 'bn': 'ms', 
            'bg': 'bg', 'bf': 'fr', 'bi': 'fr', 'kh': 'km', 'cm': 'fr', 'ca': 'en', 'cv': 'pt', 'ky': 'en', 
            'cf': 'fr', 'td': 'fr', 'cl': 'es', 'cn': 'zh', 'cx': 'en', 'cc': 'en', 'co': 'es', 'km': 'ar', 
            'ck': 'en', 'cr': 'es', 'hr': 'hr', 'cu': 'es', 'cw': 'nl', 'cy': 'el', 'cz': 'cs', 'cd': 'fr', 
            'dk': 'da', 'dj': 'fr', 'dm': 'en', 'do': 'es', 'tl': 'pt', 'ec': 'es', 'eg': 'ar', 'sv': 'es', 
            'gq': 'es', 'er': 'ti', 'ee': 'et', 'et': 'am', 'fk': 'en', 'fo': 'fo', 'fj': 'en', 'fi': 'fi', 
            'fr': 'fr', 'pf': 'fr', 'ga': 'fr', 'gm': 'en', 'ge': 'ka', 'de': 'de', 'gh': 'en', 'gi': 'en', 
            'gr': 'el', 'gl': 'kl', 'gd': 'en', 'gu': 'en', 'gt': 'es', 'gg': 'en', 'gn': 'fr', 'gw': 'pt', 
            'gy': 'en', 'ht': 'fr', 'hn': 'es', 'hk': 'zh', 'hu': 'hu', 'is': 'is', 'in': 'hi', 'id': 'id', 
            'ir': 'fa', 'iq': 'ar', 'ie': 'en', 'im': 'en', 'il': 'he', 'it': 'it', 'ci': 'fr', 'jm': 'en', 
            'jp': 'ja', 'je': 'en', 'jo': 'ar', 'kz': 'kk', 'ke': 'sw', 'ki': 'en', 'xk': 'sq', 'kw': 'ar', 
            'kg': 'ky', 'la': 'lo', 'lv': 'lv', 'lb': 'ar', 'ls': 'en', 'lr': 'en', 'ly': 'ar', 'li': 'de', 
            'lt': 'lt', 'lu': 'lb', 'mo': 'zh', 'mk': 'mk', 'mg': 'mg', 'mw': 'en', 'my': 'ms', 'mv': 'dv', 
            'ml': 'fr', 'mt': 'mt', 'mh': 'en', 'mr': 'ar', 'mu': 'en', 'yt': 'fr', 'mx': 'es', 'fm': 'en', 
            'md': 'ro', 'mc': 'fr', 'mn': 'mn', 'me': 'sr', 'ms': 'en', 'ma': 'ar', 'mz': 'pt', 'mm': 'my', 
            'na': 'en', 'nr': 'na', 'np': 'ne', 'nl': 'nl', 'an': 'nl', 'nc': 'fr', 'nz': 'en', 'ni': 'es', 
            'ne': 'fr', 'ng': 'en', 'nu': 'niu', 'kp': 'ko', 'mp': 'en', 'no': 'no', 'om': 'ar', 'pk': 'ur', 
            'pw': 'en', 'ps': 'ar', 'pa': 'es', 'pg': 'en', 'py': 'es', 'pe': 'es', 'ph': 'tl', 'pn': 'en', 
            'pl': 'pl', 'pt': 'pt', 'pr': 'es', 'qa': 'ar', 'cg': 'fr', 're': 'fr', 'ro': 'ro', 'ru': 'ru', 
            'rw': 'rw', 'bl': 'fr', 'sh': 'en', 'kn': 'en', 'lc': 'en', 'mf': 'fr', 'pm': 'fr', 'vc': 'en', 
            'ws': 'sm', 'sm': 'it', 'st': 'pt', 'sa': 'ar', 'sn': 'fr', 'rs': 'sr', 'sc': 'en', 'sl': 'en', 
            'sg': 'en', 'sx': 'nl', 'sk': 'sk', 'si': 'sl', 'sb': 'en', 'so': 'so', 'za': 'af', 'kr': 'ko', 
            'ss': 'en', 'es': 'es', 'lk': 'si', 'sd': 'ar', 'sr': 'nl', 'sj': 'no', 'sz': 'en', 'se': 'sv', 
            'ch': 'de', 'sy': 'ar', 'tw': 'zh', 'tj': 'tg', 'tz': 'sw', 'th': 'th', 'tg': 'fr', 'tk': 'tk', 
            'to': 'to', 'tt': 'en', 'tn': 'ar', 'tr': 'tr', 'tm': 'tk', 'tc': 'en', 'tv': 'en', 'vi': 'en', 
            'ug': 'en', 'ua': 'uk', 'ae': 'ar', 'gb': 'en', 'us': 'en', 'uy': 'es', 'uz': 'uz', 'vu': 'bi', 
            'va': 'la', 've': 'es', 'vn': 'vi', 'wf': 'fr', 'eh': 'ar', 'ye': 'ar', 'zm': 'en', 'zw': 'en',
            'other': 'en'
        };

        // Default avatar URL
        const defaultAvatar = 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';

        // Generate unique device ID
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }

        // Toggle between login and register forms
        showRegister.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        showLogin.addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Handle avatar upload for registration
        registerAvatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size should be less than 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    registerAvatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
                selectedAvatarFile = file;
            }
        });

        // Handle avatar upload for profile
        profileAvatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size should be less than 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    profileAvatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
                selectedAvatarFile = file;
            }
        });

        // Upload image to Firebase Storage and return URL
        async function uploadImage(file, userId) {
            if (!file) return null;
            
            try {
                const storageRef = storage.ref(`profile_images/${userId}/${file.name}`);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                return null;
            }
        }

        // Register new user
        registerBtn.addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const country = document.getElementById('register-country').value;
            const timezone = document.getElementById('register-timezone').value;
            const province = document.getElementById('register-province').value;
            const city = document.getElementById('register-city').value || document.getElementById('register-city-other').value;
            const description = document.getElementById('register-description').value;
            const gender = document.getElementById('register-gender').value;

            if (!email || !password || !username || !country || !gender) {
                alert('Please fill all required fields');
                return;
            }

            try {
                // Check if device or IP is banned
                const ipInfo = await getIpInfo();
                if (!ipInfo) {
                    throw new Error("Could not verify your location. Registration is disabled.");
                }
                const ipAddress = ipInfo.ip.replace(/\./g, '_');
                const ipBanSnapshot = await database.ref('banned_ips/' + ipAddress).once('value');
                const deviceBanSnapshot = await database.ref('banned_devices/' + deviceId).once('value');

                if (ipBanSnapshot.exists() || deviceBanSnapshot.exists()) {
                    throw new Error('Your IP or device is permanently banned.');
                }

                // Check if device already has an account
                const deviceSnapshot = await database.ref('devices').orderByChild('deviceId').equalTo(deviceId).once('value');
                if (deviceSnapshot.numChildren() >= 2) {
                    throw new Error('You have reached the maximum number of accounts for this device (2).');
                }
                
                // Create user with email and password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Upload profile image if selected
                let avatarUrl = defaultAvatar;
                if (selectedAvatarFile) {
                    avatarUrl = await uploadImage(selectedAvatarFile, user.uid);
                }
                
                // Save user data to database
                const countryCode = ipInfo.country.toLowerCase();
                const userData = {
                    username: username,
                    email: email,
                    country: countryCode,
                    timezone: timezone,
                    description: description || '',
                    avatar: avatarUrl,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    status: 'online',
                    deviceId: deviceId,
                    language: languageCodes[countryCode] || 'en',
                    gender: gender
                };

                if (countryCode === 'id') {
                    userData.province = province;
                    userData.city = city;
                } else {
                    userData.city = city;
                }

                await Promise.all([
                    database.ref('users/' + user.uid).set(userData),
                    database.ref('devices/' + deviceId).set({
                        userId: user.uid,
                        registeredAt: firebase.database.ServerValue.TIMESTAMP
                    })
                ]);
                
                alert('Registration successful! Please login.');
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                document.getElementById('register-form').reset();
                registerAvatarPreview.src = '';
                selectedAvatarFile = null;
            } catch (error) {
                alert(error.message);
            }
        });

        // Login user
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Check if user is banned
                const banSnapshot = await database.ref('bans/' + currentUser.uid).once('value');
                if (banSnapshot.exists()) {
                    const banData = banSnapshot.val();
                    if (banData.permanent || banData.until > Date.now()) {
                        const banReason = banData.reason || 'Violation of community guidelines';
                        const banMessage = banData.permanent 
                            ? `Your account has been permanently banned. Reason: ${banReason}`
                            : `Your account has been temporarily banned until ${new Date(banData.until).toLocaleString()}. Reason: ${banReason}`;
                        await auth.signOut();
                        throw new Error(banMessage);
                    } else {
                        // Remove expired ban
                        await database.ref('bans/' + currentUser.uid).remove();
                    }
                }
                
                // Verify device ID
                const userSnapshot = await database.ref('users/' + currentUser.uid + '/deviceId').once('value');
                const userDeviceId = userSnapshot.val();
                
                if (userDeviceId !== deviceId) {
                    await auth.signOut();
                    throw new Error('This account is registered on a different device. Only one device per account is allowed.');
                }
                
                // Check if user is admin
                isAdmin = adminEmails.includes(currentUser.email);
                
                // Update user status to online
                await database.ref('users/' + currentUser.uid).update({
                    status: 'online',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Switch to chat interface
                authContainer.classList.remove('active');
                chatContainer.classList.add('active');
                
                // Load users and messages
                loadUsers();
                setupPresence();
                setupMessageManagementListeners();
                updateFollowingCount();
                
                // Set target language based on user's country
                const userCountry = await database.ref('users/' + currentUser.uid + '/country').once('value');
                if (userCountry.exists()) {
                    targetLanguage = languageCodes[userCountry.val()] || 'en';
                }
            } catch (error) {
                alert(error.message);
            }
        });

        // Logout user
        logoutBtn.addEventListener('click', async () => {
            try {
                // Update user status to offline before signing out
                if (currentUser) {
                    await database.ref('users/' + currentUser.uid).update({
                        status: 'offline',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // Remove all listeners
                for (const listenerId in messageListeners) {
                    database.ref('messages').off('child_added', messageListeners[listenerId]);
                }
                messageListeners = {};
                
                for (const listenerId in userListeners) {
                    database.ref('users/' + listenerId).off('value', userListeners[listenerId]);
                }
                userListeners = {};
                
                for (const listenerId in followListeners) {
                    database.ref('follows/' + currentUser.uid + '/' + listenerId).off('value', followListeners[listenerId]);
                }
                followListeners = {};
                
                // Remove message management listeners
                if (allMessagesListener) {
                    database.ref('messages').off('child_added', allMessagesListener);
                    database.ref('messages').off('child_changed', allMessagesListener);
                    allMessagesListener = null;
                }
                
                if (unreadMessagesListener) {
                    database.ref('messages').off('child_added', unreadMessagesListener);
                    database.ref('messages').off('child_changed', unreadMessagesListener);
                    unreadMessagesListener = null;
                }
                
                if (followingListener) {
                    database.ref('follows/' + currentUser.uid).off('value', followingListener);
                    followingListener = null;
                }
                
                await auth.signOut();
                
                chatContainer.classList.remove('active');
                profileContainer.classList.remove('active');
                messagesContainer.classList.remove('active');
                authContainer.classList.add('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                currentUser = null;
                chatMessagesContainer.innerHTML = '';
                usersList.innerHTML = '';
                profileView.style.display = 'none';
                unreadMessages = {};
                selectedAvatarFile = null;
                translateEnabled = false;
                translateBtn.textContent = 'Translate';
                isAdmin = false;
            } catch (error) {
                alert('Error during logout: ' + error.message);
            }
        });

        // Show profile edit form
        profileBtn.addEventListener('click', async () => {
            chatContainer.classList.remove('active');
            messagesContainer.classList.remove('active');
            profileContainer.classList.add('active');
            
            try {
                // Load current profile data
                const snapshot = await database.ref('users/' + currentUser.uid).once('value');
                const user = snapshot.val();
                
                document.getElementById('profile-username').value = user.username;
                document.getElementById('profile-country').value = user.country || '';
                document.getElementById('profile-description').value = user.description || '';
                profileAvatarPreview.src = user.avatar || defaultAvatar;
                
                // Disable username and country fields
                document.getElementById('profile-username').classList.add('readonly-field');
                document.getElementById('profile-username').readOnly = true;
                document.getElementById('profile-country').disabled = true;
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        });

        // Show messages management
        messagesBtn.addEventListener('click', () => {
            chatContainer.classList.remove('active');
            profileContainer.classList.remove('active');
            messagesContainer.classList.add('active');
        });

        // Back to chat from messages management
        backToChatBtn.addEventListener('click', () => {
            messagesContainer.classList.remove('active');
            profileContainer.classList.remove('active');
            chatContainer.classList.add('active');
        });

        // Switch between message tabs
        messageTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                messageTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.messages-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show selected tab content
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-messages-tab`).style.display = 'block';
            });
        });

        // Save profile
        saveProfileBtn.addEventListener('click', async () => {
            const description = document.getElementById('profile-description').value;
            
            try {
                let avatarUrl = profileAvatarPreview.src;
                
                // Upload new image if selected
                if (selectedAvatarFile) {
                    avatarUrl = await uploadImage(selectedAvatarFile, currentUser.uid);
                }
                
                // Update profile in database
                await database.ref('users/' + currentUser.uid).update({
                    description: description || '',
                    avatar: avatarUrl
                });
                
                profileContainer.classList.remove('active');
                chatContainer.classList.add('active');
                loadUsers(); // Refresh user list
                
                // Update profile view if viewing own profile
                if (currentChatWith === currentUser.uid) {
                    showUserProfile(currentUser.uid);
                }
                
                selectedAvatarFile = null;
            } catch (error) {
                alert('Error saving profile: ' + error.message);
            }
        });

        // Cancel profile edit
        cancelProfileBtn.addEventListener('click', () => {
            profileContainer.classList.remove('active');
            chatContainer.classList.add('active');
            selectedAvatarFile = null;
        });

        // Setup presence tracking
        function setupPresence() {
            const userStatusDatabaseRef = database.ref('users/' + currentUser.uid);
            
            // Set user to online when connected
            userStatusDatabaseRef.update({
                status: 'online',
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Set user to offline when disconnected
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    return;
                }
                
                userStatusDatabaseRef.onDisconnect().update({
                    status: 'offline',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            });
        }

        // Setup real-time listeners for message management
        function setupMessageManagementListeners() {
            // All messages listener
            allMessagesListener = database.ref('messages')
                .orderByChild('conversationId')
                .startAt(getConversationId(currentUser.uid, ''))
                .endAt(getConversationId(currentUser.uid, '~'))
                .on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    addMessageToAllMessagesTable(message, snapshot.key);
                });
            
            // Unread messages listener
            unreadMessagesListener = database.ref('messages')
                .orderByChild('receiverId')
                .equalTo(currentUser.uid)
                .on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    if (!message.read) {
                        addMessageToUnreadMessagesTable(message, snapshot.key);
                    }
                });
            
            // Following listener
            followingListener = database.ref('follows/' + currentUser.uid)
                .on('child_added', (snapshot) => {
                    const userId = snapshot.key;
                    addUserToFollowingTable(userId);
                });
        }

        // Load all users sorted by online status
        function loadUsers(searchTerm = '', selectedCountry = '') {
            database.ref('users').on('value', (snapshot) => {
                usersList.innerHTML = '';
                const users = snapshot.val();
                let usersArray = [];
                
                for (const userId in users) {
                    if (userId === currentUser.uid) continue; // Skip current user
                    usersArray.push({ id: userId, ...users[userId] });
                }
                
                // Filter users based on search term and selected country
                if (searchTerm) {
                    usersArray = usersArray.filter(user =>
                        user.username.toLowerCase().includes(searchTerm)
                    );
                }

                if (selectedCountry) {
                    usersArray = usersArray.filter(user =>
                        user.country === selectedCountry
                    );
                }

                // Sort users: online first, then by last seen (newest first)
                usersArray.sort((a, b) => {
                    if (a.status === 'online' && b.status !== 'online') return -1;
                    if (a.status !== 'online' && b.status === 'online') return 1;
                    return (b.lastSeen || 0) - (a.lastSeen || 0);
                });
                
                usersArray.forEach(user => {
                    // Skip offline users if filter is active
                    if (showOnlineOnly && user.status !== 'online') return;
                    
                    const userItem = document.createElement('li');
                    userItem.className = 'user-item';
                    
                    // Check if user is blocked
                    database.ref('blocks/' + currentUser.uid + '/' + user.id).once('value')
                        .then((blockSnapshot) => {
                            if (blockSnapshot.exists()) {
                                userItem.innerHTML = `
                                    <div class="user-status offline"></div>
                                    <img class="user-avatar" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                    <div class="user-info">
                                        <div class="user-name">${user.username} (Blocked)</div>
                                        <div class="user-country">
                                            <span class="country-flag">${countryFlags[user.country] || '🌍'}</span>
                                            ${countryNames[user.country] || 'Other Country'}
                                        </div>
                                    </div>
                                    <div class="last-seen">${formatLastSeen(user.lastSeen)}</div>
                                    <div class="user-actions">
                                        <button class="action-btn delete-btn" data-userid="${user.id}">×</button>
                                    </div>
                                `;
                                userItem.style.opacity = '0.6';
                            } else {
                                // Check if user is banned
                                database.ref('bans/' + user.id).once('value')
                                    .then((banSnapshot) => {
                                        const isBanned = banSnapshot.exists();
                                        const banData = banSnapshot.val();
                                        const isPermanentlyBanned = isBanned && banData.permanent;
                                        const isTemporarilyBanned = isBanned && !banData.permanent && banData.until > Date.now();
                                        
                                        // Check if user is followed
                                        database.ref('follows/' + currentUser.uid + '/' + user.id).once('value')
                                            .then((followSnapshot) => {
                                                const isFollowing = followSnapshot.exists();
                                                
                                                // Get follower count
                                                database.ref('follows/' + user.id).once('value')
                                                    .then((followersSnapshot) => {
                                                        const followersCount = followersSnapshot.numChildren();
                                                        
                                                        userItem.innerHTML = `
                                                            <div class="user-status ${user.status === 'online' && !isBanned ? 'online pulse' : 'offline'}"></div>
                                                            <img class="user-avatar" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                                            <div class="user-info">
                                                                <div class="user-name">${user.username}${isBanned ? (isPermanentlyBanned ? ' (Permanently Banned)' : ' (Temporarily Banned)') : ''}</div>
                                                                <div class="user-country">
                                                                    <span class="country-flag">${countryFlags[user.country] || '🌍'}</span>
                                                                    ${countryNames[user.country] || 'Other Country'}
                                                                </div>
                                                                <div class="follower-count">${followersCount} follower${followersCount !== 1 ? 's' : ''}</div>
                                                            </div>
                                                            <div class="last-seen">${formatLastSeen(user.lastSeen)}</div>
                                                            <div class="user-actions">
                                                                <button class="action-btn block-btn" data-userid="${user.id}">B</button>
                                                                <button class="action-btn ${isFollowing ? 'unfollow-btn' : 'follow-btn'}" data-userid="${user.id}">${isFollowing ? '×' : '+'}</button>
                                                            </div>
                                                        `;
                                                        
                                                        // Add event listeners to action buttons
                                                        const blockBtn = userItem.querySelector('.block-btn');
                                                        if (blockBtn) {
                                                            blockBtn.addEventListener('click', (e) => {
                                                                e.stopPropagation();
                                                                blockUser(user.id);
                                                            });
                                                        }
                                                        
                                                        const followBtn = userItem.querySelector('.follow-btn, .unfollow-btn');
                                                        if (followBtn) {
                                                            followBtn.addEventListener('click', (e) => {
                                                                e.stopPropagation();
                                                                if (followBtn.classList.contains('follow-btn')) {
                                                                    followUser(user.id);
                                                                } else {
                                                                    unfollowUser(user.id);
                                                                }
                                                            });
                                                        }
                                                    });
                                            });
                                    });
                            }
                            
                            userItem.addEventListener('click', () => {
                                // Remove active class from all users
                                document.querySelectorAll('.user-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                // Add active class to selected user
                                userItem.classList.add('active');
                                
                                // Show profile and messages
                                showUserProfile(user.id);
                                loadMessages(user.id);
                            });
                            
                            usersList.appendChild(userItem);
                        });
                });
            });
        }

        // Show user profile
        function showUserProfile(userId) {
            // Remove previous listener if exists
            if (userListeners[userId]) {
                database.ref('users/' + userId).off('value', userListeners[userId]);
            }
            
            // Add new listener for real-time updates
            userListeners[userId] = database.ref('users/' + userId).on('value', (snapshot) => {
                const user = snapshot.val();
                if (!user) return;
                
                viewProfileName.textContent = user.username;
                viewProfileAvatar.src = user.avatar || defaultAvatar;
                viewProfileCountry.innerHTML = `
                    <span class="profile-country-flag">${countryFlags[user.country] || '🌍'}</span>
                    ${countryNames[user.country] || 'Other Country'}
                `;
                viewProfileDescription.textContent = user.description || 'No description provided';
                
                // Check if user is banned
                database.ref('bans/' + userId).once('value')
                    .then((banSnapshot) => {
                        const isBanned = banSnapshot.exists();
                        const banData = banSnapshot.val();
                        
                        if (isBanned) {
                            if (banData.permanent) {
                                viewProfileStatus.textContent = 'Permanently Banned';
                            } else if (banData.until > Date.now()) {
                                viewProfileStatus.textContent = `Temporarily Banned until ${new Date(banData.until).toLocaleString()}`;
                            } else {
                                viewProfileStatus.textContent = user.status === 'online' ? 'Online' : `Last seen ${formatLastSeen(user.lastSeen)}`;
                            }
                        } else {
                            viewProfileStatus.textContent = user.status === 'online' ? 'Online' : `Last seen ${formatLastSeen(user.lastSeen)}`;
                        }
                    });
                
        // Update follower count in real-time
        database.ref('follows/' + userId).on('value', (followersSnapshot) => {
            const count = followersSnapshot.numChildren();
            followersCount.textContent = count;
        });
                
                // Check if current user is following this user
                database.ref('follows/' + currentUser.uid + '/' + userId).once('value')
                    .then((followSnapshot) => {
                        if (followSnapshot.exists()) {
                            followBtn.style.display = 'none';
                            unfollowBtn.style.display = 'block';
                            unfollowBtn.onclick = () => unfollowUser(userId);
                        } else {
                            followBtn.style.display = 'block';
                            unfollowBtn.style.display = 'none';
                            followBtn.onclick = () => followUser(userId);
                        }
                    });
                
                // Show admin controls if current user is admin and viewing another user's profile
                if (isAdmin && userId !== currentUser.uid) {
                    adminControls.style.display = 'flex';
                    
                    // Check if user is currently banned
                    database.ref('bans/' + userId).once('value')
                        .then((banSnapshot) => {
                            const isBanned = banSnapshot.exists();
                            const banData = banSnapshot.val();
                            
                            if (isBanned) {
                                if (banData.permanent) {
                                    tempBanBtn.style.display = 'none';
                                    permBanBtn.style.display = 'none';
                                    unbanBtn.style.display = 'block';
                                } else {
                                    tempBanBtn.style.display = 'none';
                                    permBanBtn.style.display = 'block';
                                    unbanBtn.style.display = 'block';
                                }
                            } else {
                                tempBanBtn.style.display = 'block';
                                permBanBtn.style.display = 'block';
                                unbanBtn.style.display = 'none';
                            }
                        });
                    
                    // Set up ban button event listeners
                    tempBanBtn.onclick = () => tempBanUser(userId);
                    permBanBtn.onclick = () => permBanUser(userId);
                    unbanBtn.onclick = () => unbanUser(userId);
                } else {
                    adminControls.style.display = 'none';
                }
                
                profileView.style.display = 'block';
                currentChatWith = userId;
            });
        }

        // Update current user's following count in real-time
        function updateFollowingCount() {
            database.ref('follows/' + currentUser.uid).on('value', (snapshot) => {
                const count = snapshot.numChildren();
                followingCount.textContent = count;
            });
        }

        // Follow a user
        function followUser(userId) {
            database.ref('follows/' + currentUser.uid + '/' + userId).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                // Add real-time listener for follow status
                if (!followListeners[userId]) {
                    followListeners[userId] = database.ref('follows/' + currentUser.uid + '/' + userId).on('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            // User was unfollowed
                            if (currentChatWith === userId) {
                                showUserProfile(userId);
                            }
                        }
                    });
                }
                
                loadUsers(); // Refresh user list
                addUserToFollowingTable(userId); // Add to following list
                updateFollowingCount(); // Update following count
                
                if (currentChatWith === userId) {
                    showUserProfile(userId); // Update profile view
                }
            })
            .catch((error) => {
                alert('Error following user: ' + error.message);
            });
        }

        // Unfollow a user
        function unfollowUser(userId) {
            database.ref('follows/' + currentUser.uid + '/' + userId).remove()
                .then(() => {
                    loadUsers(); // Refresh user list
                    removeUserFromFollowingTable(userId); // Remove from following list
                    updateFollowingCount(); // Update following count
                    
                    if (currentChatWith === userId) {
                        showUserProfile(userId); // Update profile view
                    }
                })
                .catch((error) => {
                    alert('Error unfollowing user: ' + error.message);
                });
        }

        // Block a user
        function blockUser(userId) {
            if (confirm('Are you sure you want to block this user?')) {
                database.ref('blocks/' + currentUser.uid + '/' + userId).set(true)
                    .then(() => {
                        alert('User blocked successfully');
                        loadUsers(); // Refresh user list
                    })
                    .catch((error) => {
                        alert('Error blocking user: ' + error.message);
                    });
            }
        }

        // Delete a user (remove from your contacts)
        function deleteUser(userId) {
            if (confirm('Are you sure you want to remove this user from your contacts?')) {
                // Remove from follows
                database.ref('follows/' + currentUser.uid + '/' + userId).remove()
                    .then(() => {
                        alert('User removed successfully');
                        loadUsers(); // Refresh user list
                        chatMessagesContainer.innerHTML = '';
                        profileView.style.display = 'none';
                    })
                    .catch((error) => {
                        alert('Error removing user: ' + error.message);
                    });
            }
        }

        // Temporary ban a user (7 days)
        function tempBanUser(userId) {
            if (confirm('Temporarily ban this user for 7 days?')) {
                const banUntil = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days from now
                const reason = prompt('Enter reason for temporary ban:', 'Violation of community guidelines');
                
                if (reason !== null) {
                    database.ref('bans/' + userId).set({
                        permanent: false,
                        until: banUntil,
                        reason: reason || 'Violation of community guidelines',
                        bannedBy: currentUser.uid,
                        bannedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        alert('User temporarily banned for 7 days');
                        loadUsers(); // Refresh user list
                        if (currentChatWith === userId) {
                            showUserProfile(userId); // Update profile view
                        }
                    })
                    .catch((error) => {
                        alert('Error banning user: ' + error.message);
                    });
                }
            }
        }

        // Permanently ban a user
        function permBanUser(userId) {
            if (confirm('Permanently ban this user?')) {
                const reason = prompt('Enter reason for permanent ban:', 'Serious violation of community guidelines');
                
                if (reason !== null) {
                    database.ref('bans/' + userId).set({
                        permanent: true,
                        reason: reason || 'Serious violation of community guidelines',
                        bannedBy: currentUser.uid,
                        bannedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        alert('User permanently banned');
                        loadUsers(); // Refresh user list
                        if (currentChatWith === userId) {
                            showUserProfile(userId); // Update profile view
                        }
                    })
                    .catch((error) => {
                        alert('Error banning user: ' + error.message);
                    });
                }
            }
        }

        // Unban a user
        function unbanUser(userId) {
            if (confirm('Unban this user?')) {
                database.ref('bans/' + userId).remove()
                    .then(() => {
                        alert('User unbanned successfully');
                        loadUsers(); // Refresh user list
                        if (currentChatWith === userId) {
                            showUserProfile(userId); // Update profile view
                        }
                    })
                    .catch((error) => {
                        alert('Error unbanning user: ' + error.message);
                    });
            }
        }

        // Format last seen time
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Never';
            
            const now = Date.now();
            const lastSeen = new Date(timestamp);
            const diff = now - timestamp;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                const minutes = Math.floor(diff / 60000);
                return `${minutes} min${minutes !== 1 ? 's' : ''} ago`;
            } else if (diff < 86400000) { // Less than 1 day
                const hours = Math.floor(diff / 3600000);
                return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diff / 86400000);
                return `${days} day${days !== 1 ? 's' : ''} ago`;
            }
        }

        // Format message timestamp for tables
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            return date.toLocaleString([], { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Load messages between current user and selected user
        function loadMessages(otherUserId) {
            chatMessagesContainer.innerHTML = '';
            
            // Remove previous listener if exists
            if (messageListeners[otherUserId]) {
                database.ref('messages').off('child_added', messageListeners[otherUserId]);
            }
            
            // Get messages where current user is either sender or receiver
            const messagesRef = database.ref('messages')
                .orderByChild('conversationId')
                .equalTo(getConversationId(currentUser.uid, otherUserId));
            
            // Add new listener
            messageListeners[otherUserId] = messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
                
                // Mark as read if it's a received message
                if (message.receiverId === currentUser.uid && !message.read) {
                    database.ref('messages/' + snapshot.key).update({ read: true });
                    removeMessageFromUnreadTable(snapshot.key);
                }
            });
        }

        // Display a message in the chat area
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            if (message.receiverId === currentUser.uid && !message.read) {
                messageElement.classList.add('unread');
            }
            
            // Get username and avatar of the sender
            database.ref('users/' + message.senderId).once('value', (snapshot) => {
                const user = snapshot.val();
                const username = user.username;
                const avatar = user.avatar || defaultAvatar;
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <img class="message-avatar" src="${avatar}" alt="${username}">
                        <div class="message-sender">
                            ${message.senderId === currentUser.uid ? 'You' : username}
                        </div>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${message.content}</div>
                `;
                
                chatMessagesContainer.appendChild(messageElement);
                scrollToBottom();
            });
        }

        // Scroll chat messages to bottom
        function scrollToBottom() {
            // Use setTimeout to ensure the DOM has updated
            setTimeout(() => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }, 100);
        }

        // Format message timestamp
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Generate conversation ID for two users
        function getConversationId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        // Add message to all messages table
        function addMessageToAllMessagesTable(message, messageId) {
            // Skip if not part of current user's conversations
            if (!message.conversationId.includes(currentUser.uid)) return;
            
            // Get sender info
            database.ref('users/' + message.senderId).once('value', (userSnapshot) => {
                const user = userSnapshot.val();
                const isCurrentUser = message.senderId === currentUser.uid;
                const isRead = message.read || isCurrentUser;
                
                const existingRow = document.querySelector(`#all-messages-list tr[data-messageid="${messageId}"]`);
                
                if (existingRow) {
                    // Update existing row
                    existingRow.className = isRead ? 'message-row' : 'message-row unread-message';
                    existingRow.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${isCurrentUser ? 'You' : user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td>${isCurrentUser ? 'Sent' : (isRead ? 'Read' : 'Unread')}</td>
                    `;
                } else {
                    // Create new row
                    const row = document.createElement('tr');
                    row.className = isRead ? 'message-row' : 'message-row unread-message';
                    row.dataset.messageid = messageId;
                    row.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${isCurrentUser ? 'You' : user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td>${isCurrentUser ? 'Sent' : (isRead ? 'Read' : 'Unread')}</td>
                    `;
                    
                    row.addEventListener('click', () => {
                        // Open chat with this user
                        const otherUserId = isCurrentUser ? message.receiverId : message.senderId;
                        currentChatWith = otherUserId;
                        
                        // Switch to chat interface
                        messagesContainer.classList.remove('active');
                        chatContainer.classList.add('active');
                        
                        // Load chat with this user
                        showUserProfile(otherUserId);
                        loadMessages(otherUserId);
                    });
                    
                    allMessagesList.appendChild(row);
                }
            });
        }

        // Add message to unread messages table
        function addMessageToUnreadMessagesTable(message, messageId) {
            // Skip if not unread or not for current user
            if (message.read || message.receiverId !== currentUser.uid) return;
            
            // Get sender info
            database.ref('users/' + message.senderId).once('value', (userSnapshot) => {
                const user = userSnapshot.val();
                
                const existingRow = document.querySelector(`#unread-messages-list tr[data-messageid="${messageId}"]`);
                
                if (existingRow) {
                    // Update existing row
                    existingRow.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td><button class="mark-read-btn" data-messageid="${messageId}">Mark as Read</button></td>
                    `;
                } else {
                    // Create new row
                    const row = document.createElement('tr');
                    row.className = 'message-row unread-message';
                    row.dataset.messageid = messageId;
                    row.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td><button class="mark-read-btn" data-messageid="${messageId}">Mark as Read</button></td>
                    `;
                    
                    row.addEventListener('click', () => {
                        // Open chat with this user
                        currentChatWith = message.senderId;
                        
                        // Switch to chat interface
                        messagesContainer.classList.remove('active');
                        chatContainer.classList.add('active');
                        
                        // Load chat with this user
                        showUserProfile(message.senderId);
                        loadMessages(message.senderId);
                    });
                    
                    // Add event listener to mark as read button
                    const markReadBtn = row.querySelector('.mark-read-btn');
                    markReadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        markMessageAsRead(messageId);
                    });
                    
                    unreadMessagesList.appendChild(row);
                }
            });
        }

        // Remove message from unread table
        function removeMessageFromUnreadTable(messageId) {
            const row = document.querySelector(`#unread-messages-list tr[data-messageid="${messageId}"]`);
            if (row) {
                row.remove();
            }
        }

        // Add user to following table
        function addUserToFollowingTable(userId) {
            // Get user info
            database.ref('users/' + userId).once('value', (userSnapshot) => {
                const user = userSnapshot.val();
                if (!user) return;
                
                // Get follower count
                database.ref('follows/' + userId).once('value', (followersSnapshot) => {
                    const followersCount = followersSnapshot.numChildren();
                    
                    const existingRow = document.querySelector(`#following-list tr[data-userid="${userId}"]`);
                    
                    if (existingRow) {
                        // Update existing row
                        existingRow.innerHTML = `
                            <td>
                                <div class="message-user">
                                    <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                    ${user.username}
                                </div>
                            </td>
                            <td>${user.status === 'online' ? 'Online' : 'Offline'}</td>
                            <td>${followersCount}</td>
                            <td>
                                <button class="unfollow-btn" data-userid="${userId}">Unfollow</button>
                            </td>
                        `;
                    } else {
                        // Create new row
                        const row = document.createElement('tr');
                        row.className = 'message-row';
                        row.dataset.userid = userId;
                        row.innerHTML = `
                            <td>
                                <div class="message-user">
                                    <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                    ${user.username}
                                </div>
                            </td>
                            <td>${user.status === 'online' ? 'Online' : 'Offline'}</td>
                            <td>${followersCount}</td>
                            <td>
                                <button class="unfollow-btn" data-userid="${userId}">Unfollow</button>
                            </td>
                        `;
                        
                        // Add event listener to unfollow button
                        const unfollowBtn = row.querySelector('.unfollow-btn');
                        unfollowBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            unfollowUser(userId);
                        });
                        
                        row.addEventListener('click', () => {
                            // Open chat with this user
                            currentChatWith = userId;
                            
                            // Switch to chat interface
                            messagesContainer.classList.remove('active');
                            chatContainer.classList.add('active');
                            
                            // Load chat with this user
                            showUserProfile(userId);
                            loadMessages(userId);
                        });
                        
                        followingList.appendChild(row);
                    }
                });
            });
        }

        // Remove user from following table
        function removeUserFromFollowingTable(userId) {
            const row = document.querySelector(`#following-list tr[data-userid="${userId}"]`);
            if (row) {
                row.remove();
            }
        }

        // Mark message as read
        function markMessageAsRead(messageId) {
            database.ref('messages/' + messageId).update({ read: true })
                .then(() => {
                    removeMessageFromUnreadTable(messageId);
                })
                .catch((error) => {
                    alert('Error marking message as read: ' + error.message);
                });
        }

        // Translate message using Deep Translate API
        async function translateMessage(text, sourceLang, targetLang) {
            if (!text || !targetLang) return text;
            if (sourceLang === targetLang) return text;

            try {
                const response = await fetch(translateApiUrl, {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json',
                        'X-RapidAPI-Key': translateApiKey,
                        'X-RapidAPI-Host': translateApiHost
                    },
                    body: JSON.stringify({
                        q: text,
                        source: sourceLang,
                        target: targetLang
                    })
                });

                if (!response.ok) {
                    throw new Error('Translation API error');
                }

                const data = await response.json();
                return data.data.translations.translatedText || text;
            } catch (error) {
                console.error('Translation error:', error);
                return text; // Return original text if translation fails
            }
        }

        // Toggle translation
        translateBtn.addEventListener('click', async () => {
            translateEnabled = !translateEnabled;

            if (translateEnabled) {
                translateBtn.innerHTML = '<i class="fas fa-language"></i> Translating...';
                translateBtn.classList.add('active');

                // Translate all messages in current chat
                if (currentChatWith) {
                    const messages = chatMessagesContainer.querySelectorAll('.message-content');
                    for (const messageElement of messages) {
                        const originalText = messageElement.dataset.originalText || messageElement.textContent;
                        if (!messageElement.dataset.originalText) {
                            messageElement.dataset.originalText = originalText;
                        }
                        const translatedText = await translateMessage(originalText, 'auto', targetLanguage);
                        messageElement.textContent = translatedText;
                    }
                }

                translateBtn.innerHTML = '<i class="fas fa-language"></i> Disable Translate';
            } else {
                translateBtn.classList.remove('active');
                // Restore original text
                const messages = chatMessagesContainer.querySelectorAll('.message-content');
                for (const messageElement of messages) {
                    if (messageElement.dataset.originalText) {
                        messageElement.textContent = messageElement.dataset.originalText;
                    }
                }
                translateBtn.innerHTML = '<i class="fas fa-language"></i> Translate';
            }
        });

        // Send message
        async function sendMessage() {
            if (!currentChatWith) {
                alert('Please select a user to chat with');
                return;
            }

            const content = messageInput.value.trim();
            if (!content) return;

            // Auto-ban for inappropriate content
            const bannedWords = ['rasis', 'bullying', 'pelecehan', 'ancaman', 'kontol', 'memek', 'anjing', 'asu', 'bangsat', 'bajingan', 'brengsek', 'rasist', 'bully', 'harassment', 'threat', 'dick', 'pussy', 'dog', 'bitch', 'asshole'];
            for (const word of bannedWords) {
                if (content.toLowerCase().includes(word)) {
                    permBanUser(currentUser.uid, 'Menggunakan bahasa yang tidak pantas.');
                    alert('Anda telah diblokir secara permanen karena menggunakan bahasa yang tidak pantas.');
                    logoutBtn.click();
                    return;
                }
            }

            // Get receiver's language preference for automatic translation
            let receiverLanguage = 'en';
            try {
                const receiverSnapshot = await database.ref('users/' + currentChatWith + '/language').once('value');
                receiverLanguage = receiverSnapshot.val() || 'en';
            } catch (error) {
                console.error('Error getting receiver language:', error);
            }

            // If receiver's language is different from sender's, translate automatically
            let finalContent = content;
            if (receiverLanguage !== 'en') {
                finalContent = await translateMessage(content, receiverLanguage);
            }

            const message = {
                senderId: currentUser.uid,
                receiverId: currentChatWith,
                content: finalContent,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                conversationId: getConversationId(currentUser.uid, currentChatWith),
                read: false,
                originalLanguage: 'en', // Assuming sender always types in English
                translatedLanguage: receiverLanguage !== 'en' ? receiverLanguage : null
            };

            database.ref('messages').push(message)
                .then(() => {
                    messageInput.value = '';
                })
                .catch((error) => {
                    alert('Error sending message: ' + error.message);
                });
        }

        // Send message on button click or Enter key
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function getLeaderboardData() {
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            const leaderboardData = [];

            for (const userId in users) {
                const user = users[userId];
                const followersSnapshot = await database.ref('follows/' + userId).once('value');
                const followersCount = followersSnapshot.numChildren();

                const sentMessagesSnapshot = await database.ref('messages').orderByChild('senderId').equalTo(userId).once('value');
                const sentMessagesCount = sentMessagesSnapshot.numChildren();

                const receivedMessagesSnapshot = await database.ref('messages').orderByChild('receiverId').equalTo(userId).once('value');
                const receivedMessages = receivedMessagesSnapshot.val() || {};

                let repliedMessagesCount = 0;
                for (const messageId in receivedMessages) {
                    const message = receivedMessages[messageId];
                    const conversationId = getConversationId(userId, message.senderId);
                    const replySnapshot = await database.ref('messages').orderByChild('conversationId').equalTo(conversationId).once('value');
                    const replies = replySnapshot.val() || {};

                    for (const replyId in replies) {
                        if (replies[replyId].senderId === userId) {
                            repliedMessagesCount++;
                            break;
                        }
                    }
                }

                const replyPercentage = sentMessagesCount > 0 ? (repliedMessagesCount / sentMessagesCount) * 100 : 0;

                leaderboardData.push({
                    username: user.username,
                    followers: followersCount,
                    replyPercentage: replyPercentage.toFixed(2)
                });
            }

            return leaderboardData;
        }

        // Populate country filter
        function populateCountryFilter() {
            for (const code in countryNames) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = countryNames[code];
                countryFilter.appendChild(option);
            }
        }

        // User search and filter functionality
        function filterUsers() {
            const searchTerm = userSearch.value.toLowerCase();
            const selectedCountry = countryFilter.value;
            
            loadUsers(searchTerm, selectedCountry);
        }

        userSearch.addEventListener('input', filterUsers);
        countryFilter.addEventListener('change', filterUsers);

        // Refresh users list
        refreshUsersBtn.addEventListener('click', () => {
            loadUsers();
        });

        // Toggle online users filter
        filterOnlineBtn.addEventListener('click', () => {
            showOnlineOnly = true;
            filterOnlineBtn.classList.add('active');
            filterAllBtn.classList.remove('active');
            loadUsers();
        });

        // Show all users
        filterAllBtn.addEventListener('click', () => {
            showOnlineOnly = false;
            filterAllBtn.classList.add('active');
            filterOnlineBtn.classList.remove('active');
            loadUsers();
        });

        // IP Geolocation and VPN Detection
        const ipApiToken = 'c67223614a53f0';

        leaderboardBtn.addEventListener('click', async () => {
            chatContainer.classList.remove('active');
            leaderboardContainer.style.display = 'flex';
            const leaderboardData = await getLeaderboardData();
            displayLeaderboard(leaderboardData, 'followers');
        });

        backToChatFromLeaderboardBtn.addEventListener('click', () => {
            leaderboardContainer.style.display = 'none';
            chatContainer.classList.add('active');
        });

        document.getElementById('sort-by-followers-btn').addEventListener('click', async () => {
            const leaderboardData = await getLeaderboardData();
            displayLeaderboard(leaderboardData, 'followers');
        });

        document.getElementById('sort-by-reply-btn').addEventListener('click', async () => {
            const leaderboardData = await getLeaderboardData();
            displayLeaderboard(leaderboardData, 'replyPercentage');
        });

        function displayLeaderboard(data, sortBy) {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';

            data.sort((a, b) => b[sortBy] - a[sortBy]);

            data.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.username}</td>
                    <td>${user.followers}</td>
                    <td>${user.replyPercentage}%</td>
                `;
                leaderboardList.appendChild(row);
            });
        }

        async function getIpInfo() {
            try {
                const response = await fetch(`https://ipinfo.io?token=${ipApiToken}`);
                if (!response.ok) {
                    throw new Error('Could not fetch IP information.');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('IP Info Error:', error);
                alert('Could not retrieve your location. Please disable any ad-blockers and try again.');
                return null;
            }
        }

        // Check auth state on page load
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // Verify device ID
                    const userSnapshot = await database.ref('users/' + user.uid + '/deviceId').once('value');
                    const userDeviceId = userSnapshot.val();
                    
                    if (userDeviceId !== deviceId) {
                        await auth.signOut();
                        throw new Error('This account is registered on a different device. Only one device per account is allowed.');
                    }
                    
                    // Check if user is banned
                    const banSnapshot = await database.ref('bans/' + user.uid).once('value');
                    if (banSnapshot.exists()) {
                        const banData = banSnapshot.val();
                        if (banData.permanent || banData.until > Date.now()) {
                            const banReason = banData.reason || 'Violation of community guidelines';
                            const banMessage = banData.permanent 
                                ? `Your account has been permanently banned. Reason: ${banReason}`
                                : `Your account has been temporarily banned until ${new Date(banData.until).toLocaleString()}. Reason: ${banReason}`;
                            await auth.signOut();
                            throw new Error(banMessage);
                        } else {
                            // Remove expired ban
                            await database.ref('bans/' + user.uid).remove();
                        }
                    }
                    
                    currentUser = user;
                    
                    // Check if user is admin
                    isAdmin = adminEmails.includes(currentUser.email);
                    
                    authContainer.classList.remove('active');
                    chatContainer.classList.add('active');
                    
                    // Update user status to online
                    await database.ref('users/' + currentUser.uid).update({
                        status: 'online',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Load users and setup presence
                    loadUsers();
                    setupPresence();
                    setupMessageManagementListeners();
                    updateFollowingCount();
                    
                    // Set target language based on user's country
                    const userCountry = await database.ref('users/' + currentUser.uid + '/country').once('value');
                    if (userCountry.exists()) {
                        targetLanguage = languageCodes[userCountry.val()] || 'en';
                    }
                } catch (error) {
                    alert(error.message);
                    chatContainer.classList.remove('active');
                    messagesContainer.classList.remove('active');
                    authContainer.classList.add('active');
                    loginForm.style.display = 'block';
                }
            } else {
                currentUser = null;
                chatContainer.classList.remove('active');
                profileContainer.classList.remove('active');
                messagesContainer.classList.remove('active');
                authContainer.classList.add('active');
            }
        });

        async function banUserPermanently(ip, deviceId) {
            const banReason = 'VPN usage detected during registration.';
            await database.ref('banned_ips/' + ip.replace(/\./g, '_')).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                reason: banReason
            });
            await database.ref('banned_devices/' + deviceId).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                reason: banReason
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            populateCountryFilter();
            const ipInfo = await getIpInfo();
            if (ipInfo) {
                if (ipInfo.privacy && (ipInfo.privacy.vpn || ipInfo.privacy.proxy || ipInfo.privacy.tor)) {
                    alert('VPN/Proxy detected. Your IP and device have been permanently banned.');
                    await banUserPermanently(ipInfo.ip, deviceId);
                    document.getElementById('register-btn').disabled = true;
                    return;
                }

                const countryCode = ipInfo.country.toLowerCase();
                const countryName = countryNames[countryCode] || 'Other Country';
                document.getElementById('register-country').value = countryName;
                document.getElementById('register-timezone').value = ipInfo.timezone;

                if (countryCode === 'id') {
                    document.getElementById('location-fields-indonesia').style.display = 'block';
                    document.getElementById('register-province').value = ipInfo.region;
                    document.getElementById('register-city').value = ipInfo.city;
                } else {
                    document.getElementById('location-fields-other').style.display = 'block';
                    document.getElementById('register-city-other').value = ipInfo.city;
                }
            }

            const faceVerificationBtn = document.getElementById('face-verification-btn');
            const video = document.getElementById('face-verification-video');
            const canvas = document.getElementById('face-verification-canvas');
            const registerBtn = document.getElementById('register-btn');
            const registerGender = document.getElementById('register-gender');
            let faceVerified = false;

            registerBtn.disabled = true;

            faceVerificationBtn.addEventListener('click', async () => {
                video.style.display = 'block';
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;

                    setTimeout(async () => {
                        canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
                        const imageDataUrl = canvas.toDataURL('image/jpeg');
                        stream.getTracks().forEach(track => track.stop());
                        video.style.display = 'none';

                        try {
                            const formData = new FormData();
                            formData.append('api_key', facePlusPlusApiKey);
                            formData.append('api_secret', facePlusPlusApiSecret);
                            formData.append('image_base64', imageDataUrl.split(',')[1]);
                            formData.append('return_attributes', 'gender');

                            const response = await fetch(facePlusPlusApiUrl, {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();
                            if (data.faces && data.faces.length > 0) {
                                const detectedGender = data.faces[0].attributes.gender.value.toLowerCase();
                                registerGender.value = detectedGender;
                                faceVerified = true;
                                alert('Face verification successful! Gender has been set automatically.');
                                registerBtn.disabled = false;
                            } else {
                                alert('Face verification failed: No face detected.');
                            }
                        } catch (error) {
                            console.error('Face verification error:', error);
                            alert('An error occurred during face verification.');
                        }
                    }, 3000);
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Could not access the camera. Please grant permission and try again.');
                    video.style.display = 'none';
                }
            });

            registerBtn.addEventListener('click', (e) => {
                if (!faceVerified) {
                    e.preventDefault();
                    alert('Please complete face verification first.');
                }
            });
        });
    </script>
</body>
</html>