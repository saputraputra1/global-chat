<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Chat Room</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(to right, #f0f2f5, #e6e9ed);
            color: #333;
            touch-action: manipulation;
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 20px auto;
            height: calc(100vh - 40px);
            background-color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-radius: 15px;
        }

        .auth-container, .chat-container, .profile-container, .messages-container {
            display: none;
            padding: 10px;
            height: 100%;
            width: 100%;
        }

        .auth-container.active, .chat-container.active, .profile-container.active, .messages-container.active {
            display: flex;
            flex-direction: column;
        }

        /* Login/Register Styles */
        .auth-form {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            margin: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            color: #333;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.3);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1rem;
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            animation: shake 0.5s;
        }

        .toggle-auth {
            text-align: center;
            margin-top: 20px;
            color: #555;
            font-size: 0.9rem;
        }

        .toggle-auth a {
            color: #007bff;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
        }

        /* Chat Styles */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background-color: #fff;
            border-bottom: 1px solid #e6e6e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .chat-header h2 {
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 50%;
        }

        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .users-sidebar {
            width: 300px;
            background-color: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e6e6e6;
            display: flex;
            flex-direction: column;
        }

        #recent-chats-container {
            margin-top: 20px;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            background-color: #e9ebee;
        }

        .users-list {
            list-style: none;
            display: flex;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .user-item {
            padding: 10px;
            margin-right: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            background-color: #fff;
            position: relative;
            min-width: 200px;
            flex-shrink: 0;
            border: 1px solid #ddd;
        }

        .user-item:hover {
            background-color: #f0f2f5;
            border-color: #007bff;
        }

        .user-item.active {
            background-color: #e7f3ff;
            border-color: #007bff;
        }

        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #fff;
        }

        .online {
            background-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.7);
        }

        .offline {
            background-color: #6c757d;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            background-color: #e9ebee;
        }

        .user-info {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }

        .user-country {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
        }

        .country-flag {
            width: 14px;
            height: 10px;
            margin-right: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .last-seen {
            font-size: 0.7rem;
            color: #aaa;
        }

        .follower-count {
            font-size: 0.6rem;
            color: #4CAF50;
            margin-top: 2px;
        }

        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px 22px;
            border-radius: 22px;
            background-color: #f0f2f5;
            animation: messageIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            word-break: break-word;
            max-width: 65%;
            align-self: flex-start;
            position: relative;
        }

        .message.sent {
            background: linear-gradient(to right, #007bff, #0056b3);
            color: white;
            align-self: flex-end;
        }

        .unread {
            background-color: #e7f3ff;
            border-left: 3px solid #007bff;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            background-color: #e9ebee;
        }

        .message-sender {
            font-weight: bold;
            color: #007bff;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: #666;
            margin-left: 10px;
        }

        .message-content {
            margin-left: 33px;
            font-size: 0.9rem;
        }

        .message-input-container {
            display: flex;
            gap: 15px;
            padding: 20px;
            position: sticky;
            bottom: 0;
            background-color: #fff;
            border-top: 1px solid #e6e6e6;
        }

        .message-input {
            flex: 1;
            padding: 15px 22px;
            border: 1px solid #ccc;
            border-radius: 28px;
            background-color: #f0f2f5;
            color: #333;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .send-button {
            width: 56px;
            height: 56px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logout-btn {
            background-color: #dc3545;
            width: auto;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .profile-btn {
            background-color: #007bff;
            width: auto;
            padding: 8px 12px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .profile-btn:hover {
            background-color: #0056b3;
        }

        .messages-btn {
            background-color: #17a2b8;
            width: auto;
            padding: 8px 12px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .messages-btn:hover {
            background-color: #117a8b;
        }

        .user-actions {
            position: absolute;
            right: 5px;
            top: 5px;
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 18px;
            height: 18px;
            padding: 0;
            font-size: 9px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .block-btn {
            background-color: #ff9800;
        }

        .block-btn:hover {
            background-color: #e68a00;
        }

        .delete-btn {
            background-color: #f44336;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .follow-btn {
            background-color: #4CAF50;
        }

        .follow-btn:hover {
            background-color: #45a049;
        }

        .unfollow-btn {
            background-color: #f44336;
        }

        .unfollow-btn:hover {
            background-color: #d32f2f;
        }

        .profile-view {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: none;
            overflow-y: auto;
            max-height: 40%;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .profile-details {
            flex: 1;
        }

        .profile-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .profile-country {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .profile-country-flag {
            width: 16px;
            height: 12px;
            margin-right: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .profile-description {
            font-size: 0.8rem;
            color: #ddd;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .profile-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 5px;
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-weight: bold;
            color: #4CAF50;
            font-size: 0.9rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #aaa;
        }

        .profile-status {
            font-size: 0.7rem;
            color: #aaa;
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        /* Message Management Styles */
        .messages-management {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .messages-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .messages-tab.active {
            border-bottom: 2px solid #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .messages-tab:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .messages-content {
            flex: 1;
            overflow-y: auto;
        }

        .messages-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .messages-table th, .messages-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .messages-table th {
            background-color: rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            font-size: 0.8rem;
        }

        .messages-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .unread-message {
            font-weight: bold;
        }

        .message-row {
            cursor: pointer;
        }

        .message-row:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .message-user {
            display: flex;
            align-items: center;
        }

        .message-avatar-small {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Admin ban controls */
        .ban-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .ban-btn {
            background-color: #ff9800;
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .ban-btn:hover {
            background-color: #e68a00;
        }

        .permanent-ban-btn {
            background-color: #f44336;
        }

        .permanent-ban-btn:hover {
            background-color: #d32f2f;
        }

        .unban-btn {
            background-color: #4CAF50;
        }

        .unban-btn:hover {
            background-color: #45a049;
        }

        /* Floating bubbles animation */
        .bubbles {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            top: 0;
            left: 0;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: rise 10s infinite ease-in;
        }

        .bubble:nth-child(1) {
            width: 30px;
            height: 30px;
            left: 10%;
            animation-duration: 8s;
        }

        .bubble:nth-child(2) {
            width: 15px;
            height: 15px;
            left: 20%;
            animation-duration: 5s;
            animation-delay: 1s;
        }

        .bubble:nth-child(3) {
            width: 40px;
            height: 40px;
            left: 35%;
            animation-duration: 7s;
            animation-delay: 2s;
        }

        .bubble:nth-child(4) {
            width: 60px;
            height: 60px;
            left: 50%;
            animation-duration: 11s;
            animation-delay: 0s;
        }

        .bubble:nth-child(5) {
            width: 25px;
            height: 25px;
            left: 55%;
            animation-duration: 6s;
            animation-delay: 1s;
        }

        .bubble:nth-child(6) {
            width: 35px;
            height: 35px;
            left: 65%;
            animation-duration: 8s;
            animation-delay: 3s;
        }

        .bubble:nth-child(7) {
            width: 20px;
            height: 20px;
            left: 75%;
            animation-duration: 7s;
            animation-delay: 2s;
        }

        .bubble:nth-child(8) {
            width: 60px;
            height: 60px;
            left: 80%;
            animation-duration: 6s;
            animation-delay: 1s;
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                transform: translateX(0);
            }
            50% {
                transform: translateX(100px);
            }
            100% {
                bottom: 1080px;
                transform: translateX(-200px);
            }
        }

        /* Profile form styles */
        .profile-form {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            margin: auto;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
            overflow-y: auto;
            max-height: 90%;
        }

        .avatar-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .avatar-upload-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .avatar-upload-btn:hover {
            background-color: #0b7dda;
        }

        #avatar-upload-input {
            display: none;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }

        .readonly-field {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: #aaa !important;
            cursor: not-allowed !important;
        }

        /* Translate button */
        .translate-btn {
            background-color: #FF9800;
            width: auto;
            padding: 6px 10px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .translate-btn:hover {
            background-color: #e68a00;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .chat-main {
                flex-direction: row;
            }
            
            .users-sidebar {
                width: 250px;
                max-height: none;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                border-bottom: none;
            }
            
            .users-list {
                display: block;
                overflow-x: hidden;
                overflow-y: auto;
            }
            
            .user-item {
                margin-right: 0;
                margin-bottom: 8px;
                min-width: auto;
            }
            
            .profile-view {
                max-height: none;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Themes */
        .theme-dark { background-color: #121212; color: #fff; }
        .theme-dark .container { background-color: #1e1e1e; }
        .theme-dark .auth-form, .theme-dark .chat-header, .theme-dark .users-sidebar, .theme-dark .message-input-container { background-color: #2c2c2c; }
        .theme-dark .message { background-color: #383838; }
        .theme-dark .message.sent { background: linear-gradient(to right, #007bff, #0056b3); }

        .theme-light { background-color: #f0f2f5; color: #333; }
        .theme-light .container { background-color: #fff; }
        .theme-light .auth-form, .theme-light .chat-header, .theme-light .users-sidebar, .theme-light .message-input-container { background-color: #f8f9fa; }
        .theme-light .message { background-color: #e9ebee; }
        .theme-light .message.sent { background-color: #007bff; color: white; }

        .theme-blue .message.sent { background: linear-gradient(to right, #007bff, #0056b3); }
        .theme-green .message.sent { background: linear-gradient(to right, #28a745, #1e7e34); }
        .theme-purple .message.sent { background: linear-gradient(to right, #6f42c1, #563d7c); }
        .theme-orange .message.sent { background: linear-gradient(to right, #fd7e14, #e3640a); }
        .theme-pink .message.sent { background: linear-gradient(to right, #e83e8c, #d63384); }
        .theme-red .message.sent { background: linear-gradient(to right, #dc3545, #c82333); }
        .theme-teal .message.sent { background: linear-gradient(to right, #20c997, #17a2b8); }
        .theme-cyan .message.sent { background: linear-gradient(to right, #17a2b8, #117a8b); }
        .theme-yellow .message.sent { background: linear-gradient(to right, #ffc107, #e0a800); }
        .theme-gray .message.sent { background: linear-gradient(to right, #6c757d, #5a6268); }
        .theme-brown .message.sent { background: linear-gradient(to right, #a1887f, #795548); }
        .theme-indigo .message.sent { background: linear-gradient(to right, #6610f2, #4a00e0); }
        .theme-lime .message.sent { background: linear-gradient(to right, #cddc39, #afb42b); }
        .theme-amber .message.sent { background: linear-gradient(to right, #ffc107, #ffab00); }
        .theme-deep-orange .message.sent { background: linear-gradient(to right, #ff5722, #e64a19); }
        .theme-deep-purple .message.sent { background: linear-gradient(to right, #673ab7, #512da8); }
        .theme-light-blue .message.sent { background: linear-gradient(to right, #03a9f4, #0288d1); }
        .theme-light-green .message.sent { background: linear-gradient(to right, #8bc34a, #689f38); }
        .theme-light-pink .message.sent { background: linear-gradient(to right, #e91e63, #c2185b); }
        .theme-light-teal .message.sent { background: linear-gradient(to right, #009688, #00796b); }
        .theme-light-cyan .message.sent { background: linear-gradient(to right, #00bcd4, #0097a7); }
        .theme-light-yellow .message.sent { background: linear-gradient(to right, #ffeb3b, #fbc02d); }

    </style>
</head>
<body>
    <div class="container">
        <video id="local-video" autoplay playsinline muted></video>
        <video id="remote-video" autoplay playsinline></video>
        <!-- Authentication Container -->
        <div id="auth-container" class="auth-container active">
            <div id="login-form" class="auth-form">
                <h2>Login to Global Chat</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <button id="login-btn">Login</button>
                <div class="toggle-auth">
                    Don't have an account? <a id="show-register">Register</a>
                </div>
            </div>

            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register for Global Chat</h2>
                <div class="form-group">
                    <label for="register-username">Username</label>
                    <input type="text" id="register-username" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="register-country">Country</label>
                    <select id="register-country" disabled>
                        <option value="">Select your country</option>
                        <option value="af">Afghanistan</option>
                        <option value="al">Albania</option>
                        <option value="dz">Algeria</option>
                        <option value="as">American Samoa</option>
                        <option value="ad">Andorra</option>
                        <option value="ao">Angola</option>
                        <option value="ai">Anguilla</option>
                        <option value="aq">Antarctica</option>
                        <option value="ag">Antigua and Barbuda</option>
                        <option value="ar">Argentina</option>
                        <option value="am">Armenia</option>
                        <option value="aw">Aruba</option>
                        <option value="au">Australia</option>
                        <option value="at">Austria</option>
                        <option value="az">Azerbaijan</option>
                        <option value="bs">Bahamas</option>
                        <option value="bh">Bahrain</option>
                        <option value="bd">Bangladesh</option>
                        <option value="bb">Barbados</option>
                        <option value="by">Belarus</option>
                        <option value="be">Belgium</option>
                        <option value="bz">Belize</option>
                        <option value="bj">Benin</option>
                        <option value="bm">Bermuda</option>
                        <option value="bt">Bhutan</option>
                        <option value="bo">Bolivia</option>
                        <option value="ba">Bosnia and Herzegovina</option>
                        <option value="bw">Botswana</option>
                        <option value="br">Brazil</option>
                        <option value="io">British Indian Ocean Territory</option>
                        <option value="vg">British Virgin Islands</option>
                        <option value="bn">Brunei</option>
                        <option value="bg">Bulgaria</option>
                        <option value="bf">Burkina Faso</option>
                        <option value="bi">Burundi</option>
                        <option value="kh">Cambodia</option>
                        <option value="cm">Cameroon</option>
                        <option value="ca">Canada</option>
                        <option value="cv">Cape Verde</option>
                        <option value="ky">Cayman Islands</option>
                        <option value="cf">Central African Republic</option>
                        <option value="td">Chad</option>
                        <option value="cl">Chile</option>
                        <option value="cn">China</option>
                        <option value="cx">Christmas Island</option>
                        <option value="cc">Cocos Islands</option>
                        <option value="co">Colombia</option>
                        <option value="km">Comoros</option>
                        <option value="ck">Cook Islands</option>
                        <option value="cr">Costa Rica</option>
                        <option value="hr">Croatia</option>
                        <option value="cu">Cuba</option>
                        <option value="cw">Curacao</option>
                        <option value="cy">Cyprus</option>
                        <option value="cz">Czech Republic</option>
                        <option value="cd">Democratic Republic of the Congo</option>
                        <option value="dk">Denmark</option>
                        <option value="dj">Djibouti</option>
                        <option value="dm">Dominica</option>
                        <option value="do">Dominican Republic</option>
                        <option value="tl">East Timor</option>
                        <option value="ec">Ecuador</option>
                        <option value="eg">Egypt</option>
                        <option value="sv">El Salvador</option>
                        <option value="gq">Equatorial Guinea</option>
                        <option value="er">Eritrea</option>
                        <option value="ee">Estonia</option>
                        <option value="et">Ethiopia</option>
                        <option value="fk">Falkland Islands</option>
                        <option value="fo">Faroe Islands</option>
                        <option value="fj">Fiji</option>
                        <option value="fi">Finland</option>
                        <option value="fr">France</option>
                        <option value="pf">French Polynesia</option>
                        <option value="ga">Gabon</option>
                        <option value="gm">Gambia</option>
                        <option value="ge">Georgia</option>
                        <option value="de">Germany</option>
                        <option value="gh">Ghana</option>
                        <option value="gi">Gibraltar</option>
                        <option value="gr">Greece</option>
                        <option value="gl">Greenland</option>
                        <option value="gd">Grenada</option>
                        <option value="gu">Guam</option>
                        <option value="gt">Guatemala</option>
                        <option value="gg">Guernsey</option>
                        <option value="gn">Guinea</option>
                        <option value="gw">Guinea-Bissau</option>
                        <option value="gy">Guyana</option>
                        <option value="ht">Haiti</option>
                        <option value="hn">Honduras</option>
                        <option value="hk">Hong Kong</option>
                        <option value="hu">Hungary</option>
                        <option value="is">Iceland</option>
                        <option value="in">India</option>
                        <option value="id">Indonesia</option>
                        <option value="ir">Iran</option>
                        <option value="iq">Iraq</option>
                        <option value="ie">Ireland</option>
                        <option value="im">Isle of Man</option>
                        <option value="il">Israel</option>
                        <option value="it">Italy</option>
                        <option value="ci">Ivory Coast</option>
                        <option value="jm">Jamaica</option>
                        <option value="jp">Japan</option>
                        <option value="je">Jersey</option>
                        <option value="jo">Jordan</option>
                        <option value="kz">Kazakhstan</option>
                        <option value="ke">Kenya</option>
                        <option value="ki">Kiribati</option>
                        <option value="xk">Kosovo</option>
                        <option value="kw">Kuwait</option>
                        <option value="kg">Kyrgyzstan</option>
                        <option value="la">Laos</option>
                        <option value="lv">Latvia</option>
                        <option value="lb">Lebanon</option>
                        <option value="ls">Lesotho</option>
                        <option value="lr">Liberia</option>
                        <option value="ly">Libya</option>
                        <option value="li">Liechtenstein</option>
                        <option value="lt">Lithuania</option>
                        <option value="lu">Luxembourg</option>
                        <option value="mo">Macau</option>
                        <option value="mk">Macedonia</option>
                        <option value="mg">Madagascar</option>
                        <option value="mw">Malawi</option>
                        <option value="my">Malaysia</option>
                        <option value="mv">Maldives</option>
                        <option value="ml">Mali</option>
                        <option value="mt">Malta</option>
                        <option value="mh">Marshall Islands</option>
                        <option value="mr">Mauritania</option>
                        <option value="mu">Mauritius</option>
                        <option value="yt">Mayotte</option>
                        <option value="mx">Mexico</option>
                        <option value="fm">Micronesia</option>
                        <option value="md">Moldova</option>
                        <option value="mc">Monaco</option>
                        <option value="mn">Mongolia</option>
                        <option value="me">Montenegro</option>
                        <option value="ms">Montserrat</option>
                        <option value="ma">Morocco</option>
                        <option value="mz">Mozambique</option>
                        <option value="mm">Myanmar</option>
                        <option value="na">Namibia</option>
                        <option value="nr">Nauru</option>
                        <option value="np">Nepal</option>
                        <option value="nl">Netherlands</option>
                        <option value="an">Netherlands Antilles</option>
                        <option value="nc">New Caledonia</option>
                        <option value="nz">New Zealand</option>
                        <option value="ni">Nicaragua</option>
                        <option value="ne">Niger</option>
                        <option value="ng">Nigeria</option>
                        <option value="nu">Niue</option>
                        <option value="kp">North Korea</option>
                        <option value="mp">Northern Mariana Islands</option>
                        <option value="no">Norway</option>
                        <option value="om">Oman</option>
                        <option value="pk">Pakistan</option>
                        <option value="pw">Palau</option>
                        <option value="ps">Palestine</option>
                        <option value="pa">Panama</option>
                        <option value="pg">Papua New Guinea</option>
                        <option value="py">Paraguay</option>
                        <option value="pe">Peru</option>
                        <option value="ph">Philippines</option>
                        <option value="pn">Pitcairn</option>
                        <option value="pl">Poland</option>
                        <option value="pt">Portugal</option>
                        <option value="pr">Puerto Rico</option>
                        <option value="qa">Qatar</option>
                        <option value="cg">Republic of the Congo</option>
                        <option value="re">Reunion</option>
                        <option value="ro">Romania</option>
                        <option value="ru">Russia</option>
                        <option value="rw">Rwanda</option>
                        <option value="bl">Saint Barthelemy</option>
                        <option value="sh">Saint Helena</option>
                        <option value="kn">Saint Kitts and Nevis</option>
                        <option value="lc">Saint Lucia</option>
                        <option value="mf">Saint Martin</option>
                        <option value="pm">Saint Pierre and Miquelon</option>
                        <option value="vc">Saint Vincent and the Grenadines</option>
                        <option value="ws">Samoa</option>
                        <option value="sm">San Marino</option>
                        <option value="st">Sao Tome and Principe</option>
                        <option value="sa">Saudi Arabia</option>
                        <option value="sn">Senegal</option>
                        <option value="rs">Serbia</option>
                        <option value="sc">Seychelles</option>
                        <option value="sl">Sierra Leone</option>
                        <option value="sg">Singapore</option>
                        <option value="sx">Sint Maarten</option>
                        <option value="sk">Slovakia</option>
                        <option value="si">Slovenia</option>
                        <option value="sb">Solomon Islands</option>
                        <option value="so">Somalia</option>
                        <option value="za">South Africa</option>
                        <option value="kr">South Korea</option>
                        <option value="ss">South Sudan</option>
                        <option value="es">Spain</option>
                        <option value="lk">Sri Lanka</option>
                        <option value="sd">Sudan</option>
                        <option value="sr">Suriname</option>
                        <option value="sj">Svalbard and Jan Mayen</option>
                        <option value="sz">Swaziland</option>
                        <option value="se">Sweden</option>
                        <option value="ch">Switzerland</option>
                        <option value="sy">Syria</option>
                        <option value="tw">Taiwan</option>
                        <option value="tj">Tajikistan</option>
                        <option value="tz">Tanzania</option>
                        <option value="th">Thailand</option>
                        <option value="tg">Togo</option>
                        <option value="tk">Tokelau</option>
                        <option value="to">Tonga</option>
                        <option value="tt">Trinidad and Tobago</option>
                        <option value="tn">Tunisia</option>
                        <option value="tr">Turkey</option>
                        <option value="tm">Turkmenistan</option>
                        <option value="tc">Turks and Caicos Islands</option>
                        <option value="tv">Tuvalu</option>
                        <option value="vi">U.S. Virgin Islands</option>
                        <option value="ug">Uganda</option>
                        <option value="ua">Ukraine</option>
                        <option value="ae">United Arab Emirates</option>
                        <option value="gb">United Kingdom</option>
                        <option value="us">United States</option>
                        <option value="uy">Uruguay</option>
                        <option value="uz">Uzbekistan</option>
                        <option value="vu">Vanuatu</option>
                        <option value="va">Vatican</option>
                        <option value="ve">Venezuela</option>
                        <option value="vn">Vietnam</option>
                        <option value="wf">Wallis and Futuna</option>
                        <option value="eh">Western Sahara</option>
                        <option value="ye">Yemen</option>
                        <option value="zm">Zambia</option>
                        <option value="zw">Zimbabwe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-description">Profile Description</label>
                    <textarea id="register-description" placeholder="Tell others about yourself"></textarea>
                </div>
                <div class="avatar-upload-container">
                    <img id="register-avatar-preview" class="avatar-preview" src="" alt="Profile Picture">
                    <label for="register-avatar-upload" class="avatar-upload-btn">Choose Profile Picture</label>
                    <input type="file" id="register-avatar-upload" accept="image/*">
                </div>
                <button id="register-btn">Register</button>
                <div class="toggle-auth">
                    Already have an account? <a id="show-login">Login</a>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="chat-container">
            <div class="chat-header">
                <h2>Global Chat Room</h2>
                <div>
                    <button id="translate-btn" class="translate-btn">Translate</button>
                    <button id="messages-btn" class="messages-btn">Messages</button>
                    <button id="profile-btn" class="profile-btn">Profile</button>
                    <button id="logout-btn" class="logout-btn">Logout</button>
                </div>
            </div>
            <div class="chat-main">
                <div class="users-sidebar">
                    <div class="search-container">
                        <input type="text" id="user-search-input" placeholder="Search by username...">
                        <select id="country-filter-select">
                            <option value="">Filter by country</option>
                        </select>
                    </div>
                    <h3>Online Users</h3>
                    <ul id="users-list" class="users-list"></ul>
                    <div id="recent-chats-container"></div>
                </div>
                <div class="chat-area">
                    <div id="profile-view" class="profile-view">
                        <div class="profile-header">
                            <img id="view-profile-avatar" class="profile-avatar" src="" alt="Profile Picture">
                            <div class="profile-details">
                                <div class="profile-name" id="view-profile-name"></div>
                                <div class="profile-country" id="view-profile-country"></div>
                                <div class="profile-status" id="view-profile-status"></div>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="followers-count">0</div>
                                <div class="stat-label">Followers</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="following-count">0</div>
                                <div class="stat-label">Following</div>
                            </div>
                        </div>
                        <div class="profile-description" id="view-profile-description"></div>
                        <div class="profile-actions">
                            <button id="voice-call-btn" class="action-btn">ðŸ“ž</button>
                            <button id="video-call-btn" class="action-btn">ðŸ“¹</button>
                            <button id="follow-btn" class="follow-btn" style="display: none;">Follow</button>
                            <button id="unfollow-btn" class="unfollow-btn" style="display: none;">Unfollow</button>
                        </div>
                        <div id="admin-controls" class="ban-controls" style="display: none;">
                            <button id="temp-ban-btn" class="ban-btn">Temporary Ban (7 days)</button>
                            <button id="perm-ban-btn" class="ban-btn permanent-ban-btn">Permanent Ban</button>
                            <button id="unban-btn" class="ban-btn unban-btn">Unban User</button>
                        </div>
                    </div>
                    <div id="chat-messages-container" class="chat-messages-container"></div>
                    <div class="message-input-container">
                        <input type="text" id="message-input" class="message-input" placeholder="Type your message...">
                        <button id="send-btn" class="send-button">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Container -->
        <div id="profile-container" class="profile-container">
            <div class="profile-form">
                <h2>Edit Profile</h2>
                <div class="avatar-upload-container">
                    <img id="profile-avatar-preview" class="avatar-preview" src="" alt="Profile Picture">
                    <label for="profile-avatar-upload" class="avatar-upload-btn">Change Profile Picture</label>
                    <input type="file" id="profile-avatar-upload" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="profile-username">Username</label>
                    <input type="text" id="profile-username" placeholder="Your username" class="readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="profile-country">Country</label>
                    <select id="profile-country" class="readonly-field" disabled>
                        <option value="">Select your country</option>
                        <!-- Countries will be populated but disabled -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="profile-description">Profile Description</label>
                    <textarea id="profile-description" placeholder="Tell others about yourself"></textarea>
                </div>
                <div class="form-group">
                    <label for="theme-select">Chat Theme</label>
                    <select id="theme-select">
                        <option value="default">Default</option>
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="red">Red</option>
                        <option value="teal">Teal</option>
                        <option value="cyan">Cyan</option>
                        <option value="yellow">Yellow</option>
                        <option value="gray">Gray</option>
                        <option value="brown">Brown</option>
                        <option value="indigo">Indigo</option>
                        <option value="lime">Lime</option>
                        <option value="amber">Amber</option>
                        <option value="deep-orange">Deep Orange</option>
                        <option value="deep-purple">Deep Purple</option>
                        <option value="light-blue">Light Blue</option>
                        <option value="light-green">Light Green</option>
                        <option value="light-pink">Light Pink</option>
                        <option value="light-teal">Light Teal</option>
                        <option value="light-cyan">Light Cyan</option>
                        <option value="light-yellow">Light Yellow</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button id="save-profile-btn" class="profile-btn">Save Profile</button>
                    <button id="cancel-profile-btn" class="logout-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Container -->
        <div id="leaderboard-container" class="leaderboard-container" style="display: none;">
            <div class="chat-header">
                <h2>Leaderboard</h2>
                <button id="back-to-chat-from-leaderboard-btn" class="profile-btn">Back to Chat</button>
            </div>
            <div id="leaderboard-content"></div>
        </div>

        <!-- Public Profile Container -->
        <div id="public-profile-container" class="public-profile-container" style="display: none;">
            <div class="chat-header">
                <h2 id="public-profile-name"></h2>
                <button id="back-to-chat-from-public-profile-btn" class="profile-btn">Back to Chat</button>
            </div>
            <div id="public-profile-content">
                <div id="public-profile-followers"></div>
                <div id="public-profile-following"></div>
            </div>
        </div>

        <!-- Global Room Container -->
        <div id="global-room-container" class="global-room-container" style="display: none;">
            <div class="chat-header">
                <h2>Global Room</h2>
                <button id="leave-global-room-btn" class="profile-btn">Leave Room</button>
            </div>
            <div id="global-room-content">
                <div id="global-room-messages"></div>
                <div id="global-room-input-container">
                    <input type="text" id="global-room-input" placeholder="Type a message...">
                    <button id="global-room-send-btn">Send</button>
                </div>
                <div id="typing-indicator"></div>
            </div>
            <div id="online-users-container">
                <h3>Online Users</h3>
                <ul id="online-users-list"></ul>
            </div>
        </div>

        <!-- Messages Management Container -->
        <div id="messages-container" class="messages-container">
            <div class="chat-header">
                <h2>Message Management</h2>
                <div>
                    <button id="back-to-chat-btn" class="profile-btn">Back to Chat</button>
                </div>
            </div>
            <div class="messages-management">
                <div class="messages-tabs">
                    <div class="messages-tab active" data-tab="all">All Messages</div>
                    <div class="messages-tab" data-tab="unread">Unread Messages</div>
                    <div class="messages-tab" data-tab="following">Following</div>
                </div>
                <div class="messages-content">
                    <div id="all-messages-tab" class="messages-tab-content">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Message</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="all-messages-list"></tbody>
                        </table>
                    </div>
                    <div id="unread-messages-tab" class="messages-tab-content" style="display: none;">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Message</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="unread-messages-list"></tbody>
                        </table>
                    </div>
                    <div id="following-tab" class="messages-tab-content" style="display: none;">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Followers</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="following-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQVIvZvxmYdcriHR8j0ormGzNRjGD0_no",
            authDomain: "online--suit.firebaseapp.com",
            databaseURL: "https://online--suit-default-rtdb.firebaseio.com",
            projectId: "online--suit",
            storageBucket: "online--suit.firebasestorage.app",
            messagingSenderId: "463840835705",
            appId: "1:463840835705:web:f490fd49851c0afb8dfca8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const profileContainer = document.getElementById('profile-container');
        const messagesContainer = document.getElementById('messages-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const messagesBtn = document.getElementById('messages-btn');
        const translateBtn = document.getElementById('translate-btn');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelProfileBtn = document.getElementById('cancel-profile-btn');
        const usersList = document.getElementById('users-list');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const profileView = document.getElementById('profile-view');
        const viewProfileName = document.getElementById('view-profile-name');
        const viewProfileAvatar = document.getElementById('view-profile-avatar');
        const viewProfileCountry = document.getElementById('view-profile-country');
        const viewProfileDescription = document.getElementById('view-profile-description');
        const viewProfileStatus = document.getElementById('view-profile-status');
        const followersCount = document.getElementById('followers-count');
        const followingCount = document.getElementById('following-count');
        const followBtn = document.getElementById('follow-btn');
        const unfollowBtn = document.getElementById('unfollow-btn');
        const allMessagesList = document.getElementById('all-messages-list');
        const unreadMessagesList = document.getElementById('unread-messages-list');
        const followingList = document.getElementById('following-list');
        const messageTabs = document.querySelectorAll('.messages-tab');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const profileAvatarUpload = document.getElementById('profile-avatar-upload');
        const registerAvatarPreview = document.getElementById('register-avatar-preview');
        const registerAvatarUpload = document.getElementById('register-avatar-upload');
        const tempBanBtn = document.getElementById('temp-ban-btn');
        const permBanBtn = document.getElementById('perm-ban-btn');
        const unbanBtn = document.getElementById('unban-btn');
        const adminControls = document.getElementById('admin-controls');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const leaderboardBtn = document.createElement('button');
        leaderboardBtn.id = 'leaderboard-btn';
        leaderboardBtn.className = 'messages-btn';
        leaderboardBtn.textContent = 'Leaderboard';
        document.querySelector('.chat-header > div').insertBefore(leaderboardBtn, messagesBtn);
        const backToChatFromLeaderboardBtn = document.getElementById('back-to-chat-from-leaderboard-btn');
        const publicProfileContainer = document.getElementById('public-profile-container');
        const backToChatFromPublicProfileBtn = document.getElementById('back-to-chat-from-public-profile-btn');
        const globalRoomContainer = document.getElementById('global-room-container');
        const joinGlobalRoomBtn = document.createElement('button');
        joinGlobalRoomBtn.id = 'join-global-room-btn';
        joinGlobalRoomBtn.className = 'messages-btn';
        joinGlobalRoomBtn.textContent = 'Global Room';
        document.querySelector('.chat-header > div').insertBefore(joinGlobalRoomBtn, leaderboardBtn);
        const leaveGlobalRoomBtn = document.getElementById('leave-global-room-btn');
        const globalRoomInput = document.getElementById('global-room-input');
        const globalRoomSendBtn = document.getElementById('global-room-send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const onlineUsersList = document.getElementById('online-users-list');

        joinGlobalRoomBtn.addEventListener('click', () => {
            chatContainer.classList.remove('active');
            globalRoomContainer.style.display = 'flex';
            joinGlobalRoom();
        });

        leaveGlobalRoomBtn.addEventListener('click', () => {
            globalRoomContainer.style.display = 'none';
            chatContainer.classList.add('active');
            leaveGlobalRoom();
        });

        globalRoomSendBtn.addEventListener('click', () => {
            const content = globalRoomInput.value.trim();
            if (content) {
                sendGlobalMessage(content);
                globalRoomInput.value = '';
            }
        });

        globalRoomInput.addEventListener('input', () => {
            const typingRef = database.ref('typing/' + currentUser.uid);
            typingRef.set(true);
            setTimeout(() => typingRef.remove(), 3000);
        });

        function joinGlobalRoom() {
            const onlineUsersRef = database.ref('onlineUsers');
            onlineUsersRef.on('value', snapshot => {
                onlineUsersList.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const item = document.createElement('li');
                    item.textContent = user.username;
                    onlineUsersList.appendChild(item);
                });
            });

            const typingRef = database.ref('typing');
            typingRef.on('value', snapshot => {
                const typingUsers = [];
                snapshot.forEach(childSnapshot => {
                    typingUsers.push(childSnapshot.key);
                });
                if (typingUsers.length > 0) {
                    typingIndicator.textContent = `${typingUsers.join(', ')} is typing...`;
                } else {
                    typingIndicator.textContent = '';
                }
            });

            const globalMessagesRef = database.ref('globalMessages');
            globalMessagesRef.on('child_added', snapshot => {
                const message = snapshot.val();
                const messageElement = document.createElement('div');
                messageElement.textContent = `${message.sender}: ${message.content}`;
                document.getElementById('global-room-messages').appendChild(messageElement);
            });
        }

        function leaveGlobalRoom() {
            database.ref('onlineUsers/' + currentUser.uid).remove();
            database.ref('typing/' + currentUser.uid).remove();
            database.ref('onlineUsers').off();
            database.ref('typing').off();
            database.ref('globalMessages').off();
        }

        function sendGlobalMessage(content) {
            const message = {
                sender: currentUser.displayName,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
            };
            database.ref('globalMessages').push(message);
        }

        document.getElementById('view-profile-name').addEventListener('click', () => {
            showPublicProfile(currentChatWith);
        });

        backToChatFromPublicProfileBtn.addEventListener('click', () => {
            publicProfileContainer.style.display = 'none';
            chatContainer.classList.add('active');
        });

        async function showPublicProfile(userId) {
            chatContainer.classList.remove('active');
            publicProfileContainer.style.display = 'flex';

            const userSnapshot = await database.ref('users/' + userId).once('value');
            const user = userSnapshot.val();
            document.getElementById('public-profile-name').textContent = `${user.username}'s Profile`;

            const followersRef = database.ref('follows/' + userId);
            followersRef.on('value', snapshot => {
                const followers = [];
                snapshot.forEach(childSnapshot => {
                    followers.push(childSnapshot.key);
                });
                const followersList = document.getElementById('public-profile-followers');
                followersList.innerHTML = '<h3>Followers</h3>';
                const list = document.createElement('ul');
                followers.forEach(followerId => {
                    database.ref('users/' + followerId).once('value').then(userSnapshot => {
                        const item = document.createElement('li');
                        item.textContent = userSnapshot.val().username;
                        list.appendChild(item);
                    });
                });
                followersList.appendChild(list);
            });

            const followingRef = database.ref('users/' + userId + '/following');
            followingRef.on('value', snapshot => {
                const following = [];
                snapshot.forEach(childSnapshot => {
                    following.push(childSnapshot.key);
                });
                const followingList = document.getElementById('public-profile-following');
                followingList.innerHTML = '<h3>Following</h3>';
                const list = document.createElement('ul');
                following.forEach(followingId => {
                    database.ref('users/' + followingId).once('value').then(userSnapshot => {
                        const item = document.createElement('li');
                        item.textContent = userSnapshot.val().username;
                        list.appendChild(item);
                    });
                });
                followingList.appendChild(list);
            });
        }

        // Current user data
        let currentUser = null;
        let currentChatWith = null;
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let unreadMessages = {};
        let messageListeners = {};
        let userListeners = {};
        let followListeners = {};
        let selectedAvatarFile = null;
        let translateEnabled = false;
        let targetLanguage = 'en'; // Default to English
        let allMessagesListener = null;
        let unreadMessagesListener = null;
        let followingListener = null;
        let isAdmin = false; // Flag to check if current user is admin
        const adminEmails = ['admin@example.com']; // List of admin emails

        // Country flag mapping (complete list)
        const countryFlags = {
            'af': 'ðŸ‡¦ðŸ‡«', 'al': 'ðŸ‡¦ðŸ‡±', 'dz': 'ðŸ‡©ðŸ‡¿', 'as': 'ðŸ‡¦ðŸ‡¸', 'ad': 'ðŸ‡¦ðŸ‡©', 'ao': 'ðŸ‡¦ðŸ‡´', 'ai': 'ðŸ‡¦ðŸ‡®', 'aq': 'ðŸ‡¦ðŸ‡¶', 
            'ag': 'ðŸ‡¦ðŸ‡¬', 'ar': 'ðŸ‡¦ðŸ‡·', 'am': 'ðŸ‡¦ðŸ‡²', 'aw': 'ðŸ‡¦ðŸ‡¼', 'au': 'ðŸ‡¦ðŸ‡º', 'at': 'ðŸ‡¦ðŸ‡¹', 'az': 'ðŸ‡¦ðŸ‡¿', 'bs': 'ðŸ‡§ðŸ‡¸', 
            'bh': 'ðŸ‡§ðŸ‡­', 'bd': 'ðŸ‡§ðŸ‡©', 'bb': 'ðŸ‡§ðŸ‡§', 'by': 'ðŸ‡§ðŸ‡¾', 'be': 'ðŸ‡§ðŸ‡ª', 'bz': 'ðŸ‡§ðŸ‡¿', 'bj': 'ðŸ‡§ðŸ‡¯', 'bm': 'ðŸ‡§ðŸ‡²', 
            'bt': 'ðŸ‡§ðŸ‡¹', 'bo': 'ðŸ‡§ðŸ‡´', 'ba': 'ðŸ‡§ðŸ‡¦', 'bw': 'ðŸ‡§ðŸ‡¼', 'br': 'ðŸ‡§ðŸ‡·', 'io': 'ðŸ‡®ðŸ‡´', 'vg': 'ðŸ‡»ðŸ‡¬', 'bn': 'ðŸ‡§ðŸ‡³', 
            'bg': 'ðŸ‡§ðŸ‡¬', 'bf': 'ðŸ‡§ðŸ‡«', 'bi': 'ðŸ‡§ðŸ‡®', 'kh': 'ðŸ‡°ðŸ‡­', 'cm': 'ðŸ‡¨ðŸ‡²', 'ca': 'ðŸ‡¨ðŸ‡¦', 'cv': 'ðŸ‡¨ðŸ‡»', 'ky': 'ðŸ‡°ðŸ‡¾', 
            'cf': 'ðŸ‡¨ðŸ‡«', 'td': 'ðŸ‡¹ðŸ‡©', 'cl': 'ðŸ‡¨ðŸ‡±', 'cn': 'ðŸ‡¨ðŸ‡³', 'cx': 'ðŸ‡¨ðŸ‡½', 'cc': 'ðŸ‡¨ðŸ‡¨', 'co': 'ðŸ‡¨ðŸ‡´', 'km': 'ðŸ‡°ðŸ‡²', 
            'ck': 'ðŸ‡¨ðŸ‡°', 'cr': 'ðŸ‡¨ðŸ‡·', 'hr': 'ðŸ‡­ðŸ‡·', 'cu': 'ðŸ‡¨ðŸ‡º', 'cw': 'ðŸ‡¨ðŸ‡¼', 'cy': 'ðŸ‡¨ðŸ‡¾', 'cz': 'ðŸ‡¨ðŸ‡¿', 'cd': 'ðŸ‡¨ðŸ‡©', 
            'dk': 'ðŸ‡©ðŸ‡°', 'dj': 'ðŸ‡©ðŸ‡¯', 'dm': 'ðŸ‡©ðŸ‡²', 'do': 'ðŸ‡©ðŸ‡´', 'tl': 'ðŸ‡¹ðŸ‡±', 'ec': 'ðŸ‡ªðŸ‡¨', 'eg': 'ðŸ‡ªðŸ‡¬', 'sv': 'ðŸ‡¸ðŸ‡»', 
            'gq': 'ðŸ‡¬ðŸ‡¶', 'er': 'ðŸ‡ªðŸ‡·', 'ee': 'ðŸ‡ªðŸ‡ª', 'et': 'ðŸ‡ªðŸ‡¹', 'fk': 'ðŸ‡«ðŸ‡°', 'fo': 'ðŸ‡«ðŸ‡´', 'fj': 'ðŸ‡«ðŸ‡¯', 'fi': 'ðŸ‡«ðŸ‡®', 
            'fr': 'ðŸ‡«ðŸ‡·', 'pf': 'ðŸ‡µðŸ‡«', 'ga': 'ðŸ‡¬ðŸ‡¦', 'gm': 'ðŸ‡¬ðŸ‡²', 'ge': 'ðŸ‡¬ðŸ‡ª', 'de': 'ðŸ‡©ðŸ‡ª', 'gh': 'ðŸ‡¬ðŸ‡­', 'gi': 'ðŸ‡¬ðŸ‡®', 
            'gr': 'ðŸ‡¬ðŸ‡·', 'gl': 'ðŸ‡¬ðŸ‡±', 'gd': 'ðŸ‡¬ðŸ‡©', 'gu': 'ðŸ‡¬ðŸ‡º', 'gt': 'ðŸ‡¬ðŸ‡¹', 'gg': 'ðŸ‡¬ðŸ‡¬', 'gn': 'ðŸ‡¬ðŸ‡³', 'gw': 'ðŸ‡¬ðŸ‡¼', 
            'gy': 'ðŸ‡¬ðŸ‡¾', 'ht': 'ðŸ‡­ðŸ‡¹', 'hn': 'ðŸ‡­ðŸ‡³', 'hk': 'ðŸ‡­ðŸ‡°', 'hu': 'ðŸ‡­ðŸ‡º', 'is': 'ðŸ‡®ðŸ‡¸', 'in': 'ðŸ‡®ðŸ‡³', 'id': 'ðŸ‡®ðŸ‡©', 
            'ir': 'ðŸ‡®ðŸ‡·', 'iq': 'ðŸ‡®ðŸ‡¶', 'ie': 'ðŸ‡®ðŸ‡ª', 'im': 'ðŸ‡®ðŸ‡²', 'il': 'ðŸ‡®ðŸ‡±', 'it': 'ðŸ‡®ðŸ‡¹', 'ci': 'ðŸ‡¨ðŸ‡®', 'jm': 'ðŸ‡¯ðŸ‡²', 
            'jp': 'ðŸ‡¯ðŸ‡µ', 'je': 'ðŸ‡¯ðŸ‡ª', 'jo': 'ðŸ‡¯ðŸ‡´', 'kz': 'ðŸ‡°ðŸ‡¿', 'ke': 'ðŸ‡°ðŸ‡ª', 'ki': 'ðŸ‡°ðŸ‡®', 'xk': 'ðŸ‡½ðŸ‡°', 'kw': 'ðŸ‡°ðŸ‡¼', 
            'kg': 'ðŸ‡°ðŸ‡¬', 'la': 'ðŸ‡±ðŸ‡¦', 'lv': 'ðŸ‡±ðŸ‡»', 'lb': 'ðŸ‡±ðŸ‡§', 'ls': 'ðŸ‡±ðŸ‡¸', 'lr': 'ðŸ‡±ðŸ‡·', 'ly': 'ðŸ‡±ðŸ‡¾', 'li': 'ðŸ‡±ðŸ‡®', 
            'lt': 'ðŸ‡±ðŸ‡¹', 'lu': 'ðŸ‡±ðŸ‡º', 'mo': 'ðŸ‡²ðŸ‡´', 'mk': 'ðŸ‡²ðŸ‡°', 'mg': 'ðŸ‡²ðŸ‡¬', 'mw': 'ðŸ‡²ðŸ‡¼', 'my': 'ðŸ‡²ðŸ‡¾', 'mv': 'ðŸ‡²ðŸ‡»', 
            'ml': 'ðŸ‡²ðŸ‡±', 'mt': 'ðŸ‡²ðŸ‡¹', 'mh': 'ðŸ‡²ðŸ‡­', 'mr': 'ðŸ‡²ðŸ‡·', 'mu': 'ðŸ‡²ðŸ‡º', 'yt': 'ðŸ‡¾ðŸ‡¹', 'mx': 'ðŸ‡²ðŸ‡½', 'fm': 'ðŸ‡«ðŸ‡²', 
            'md': 'ðŸ‡²ðŸ‡©', 'mc': 'ðŸ‡²ðŸ‡¨', 'mn': 'ðŸ‡²ðŸ‡³', 'me': 'ðŸ‡²ðŸ‡ª', 'ms': 'ðŸ‡²ðŸ‡¸', 'ma': 'ðŸ‡²ðŸ‡¦', 'mz': 'ðŸ‡²ðŸ‡¿', 'mm': 'ðŸ‡²ðŸ‡²', 
            'na': 'ðŸ‡³ðŸ‡¦', 'nr': 'ðŸ‡³ðŸ‡·', 'np': 'ðŸ‡³ðŸ‡µ', 'nl': 'ðŸ‡³ðŸ‡±', 'an': 'ðŸ‡¦ðŸ‡³', 'nc': 'ðŸ‡³ðŸ‡¨', 'nz': 'ðŸ‡³ðŸ‡¿', 'ni': 'ðŸ‡³ðŸ‡®',
            'ne': 'ðŸ‡³ðŸ‡ª', 'ng': 'ðŸ‡³ðŸ‡¬', 'nu': 'ðŸ‡³ðŸ‡º', 'kp': 'ðŸ‡°ðŸ‡µ', 'mp': 'ðŸ‡²ðŸ‡µ', 'no': 'ðŸ‡³ðŸ‡´', 'om': 'ðŸ‡´ðŸ‡²', 'pk': 'ðŸ‡µðŸ‡°', 
            'pw': 'ðŸ‡µðŸ‡¼', 'ps': 'ðŸ‡µðŸ‡¸', 'pa': 'ðŸ‡µðŸ‡¦', 'pg': 'ðŸ‡µðŸ‡¬', 'py': 'ðŸ‡µðŸ‡¾', 'pe': 'ðŸ‡µðŸ‡ª', 'ph': 'ðŸ‡µðŸ‡­', 'pn': 'ðŸ‡µðŸ‡³', 
            'pl': 'ðŸ‡µðŸ‡±', 'pt': 'ðŸ‡µðŸ‡¹', 'pr': 'ðŸ‡µðŸ‡·', 'qa': 'ðŸ‡¶ðŸ‡¦', 'cg': 'ðŸ‡¨ðŸ‡¬', 're': 'ðŸ‡·ðŸ‡ª', 'ro': 'ðŸ‡·ðŸ‡´', 'ru': 'ðŸ‡·ðŸ‡º', 
            'rw': 'ðŸ‡·ðŸ‡¼', 'bl': 'ðŸ‡§ðŸ‡±', 'sh': 'ðŸ‡¸ðŸ‡­', 'kn': 'ðŸ‡°ðŸ‡³', 'lc': 'ðŸ‡±ðŸ‡¨', 'mf': 'ðŸ‡²ðŸ‡«', 'pm': 'ðŸ‡µðŸ‡²', 'vc': 'ðŸ‡»ðŸ‡¨', 
            'ws': 'ðŸ‡¼ðŸ‡¸', 'sm': 'ðŸ‡¸ðŸ‡²', 'st': 'ðŸ‡¸ðŸ‡¹', 'sa': 'ðŸ‡¸ðŸ‡¦', 'sn': 'ðŸ‡¸ðŸ‡³', 'rs': 'ðŸ‡·ðŸ‡¸', 'sc': 'ðŸ‡¸ðŸ‡¨', 'sl': 'ðŸ‡¸ðŸ‡±', 
            'sg': 'ðŸ‡¸ðŸ‡¬', 'sx': 'ðŸ‡¸ðŸ‡½', 'sk': 'ðŸ‡¸ðŸ‡°', 'si': 'ðŸ‡¸ðŸ‡®', 'sb': 'ðŸ‡¸ðŸ‡§', 'so': 'ðŸ‡¸ðŸ‡´', 'za': 'ðŸ‡¿ðŸ‡¦', 'kr': 'ðŸ‡°ðŸ‡·', 
            'ss': 'ðŸ‡¸ðŸ‡¸', 'es': 'ðŸ‡ªðŸ‡¸', 'lk': 'ðŸ‡±ðŸ‡°', 'sd': 'ðŸ‡¸ðŸ‡©', 'sr': 'ðŸ‡¸ðŸ‡·', 'sj': 'ðŸ‡¸ðŸ‡¯', 'sz': 'ðŸ‡¸ðŸ‡¿', 'se': 'ðŸ‡¸ðŸ‡ª', 
            'ch': 'ðŸ‡¨ðŸ‡­', 'sy': 'ðŸ‡¸ðŸ‡¾', 'tw': 'ðŸ‡¹ðŸ‡¼', 'tj': 'ðŸ‡¹ðŸ‡¯', 'tz': 'ðŸ‡¹ðŸ‡¿', 'th': 'ðŸ‡¹ðŸ‡­', 'tg': 'ðŸ‡¹ðŸ‡¬', 'tk': 'ðŸ‡¹ðŸ‡°', 
            'to': 'ðŸ‡¹ðŸ‡´', 'tt': 'ðŸ‡¹ðŸ‡¹', 'tn': 'ðŸ‡¹ðŸ‡³', 'tr': 'ðŸ‡¹ðŸ‡·', 'tm': 'ðŸ‡¹ðŸ‡²', 'tc': 'ðŸ‡¹ðŸ‡¨', 'tv': 'ðŸ‡¹ðŸ‡»', 'vi': 'ðŸ‡»ðŸ‡®', 
            'ug': 'ðŸ‡ºðŸ‡¬', 'ua': 'ðŸ‡ºðŸ‡¦', 'ae': 'ðŸ‡¦ðŸ‡ª', 'gb': 'ðŸ‡¬ðŸ‡§', 'us': 'ðŸ‡ºðŸ‡¸', 'uy': 'ðŸ‡ºðŸ‡¾', 'uz': 'ðŸ‡ºðŸ‡¿', 'vu': 'ðŸ‡»ðŸ‡º', 
            'va': 'ðŸ‡»ðŸ‡¦', 've': 'ðŸ‡»ðŸ‡ª', 'vn': 'ðŸ‡»ðŸ‡³', 'wf': 'ðŸ‡¼ðŸ‡«', 'eh': 'ðŸ‡ªðŸ‡­', 'ye': 'ðŸ‡¾ðŸ‡ª', 'zm': 'ðŸ‡¿ðŸ‡²', 'zw': 'ðŸ‡¿ðŸ‡¼',
            'other': 'ðŸŒ'
        };

        // Country name mapping (complete list)
        const countryNames = {
            'af': 'Afghanistan', 'al': 'Albania', 'dz': 'Algeria', 'as': 'American Samoa', 'ad': 'Andorra', 
            'ao': 'Angola', 'ai': 'Anguilla', 'aq': 'Antarctica', 'ag': 'Antigua and Barbuda', 'ar': 'Argentina', 
            'am': 'Armenia', 'aw': 'Aruba', 'au': 'Australia', 'at': 'Austria', 'az': 'Azerbaijan', 'bs': 'Bahamas', 
            'bh': 'Bahrain', 'bd': 'Bangladesh', 'bb': 'Barbados', 'by': 'Belarus', 'be': 'Belgium', 'bz': 'Belize', 
            'bj': 'Benin', 'bm': 'Bermuda', 'bt': 'Bhutan', 'bo': 'Bolivia', 'ba': 'Bosnia and Herzegovina', 
            'bw': 'Botswana', 'br': 'Brazil', 'io': 'British Indian Ocean Territory', 'vg': 'British Virgin Islands', 
            'bn': 'Brunei', 'bg': 'Bulgaria', 'bf': 'Burkina Faso', 'bi': 'Burundi', 'kh': 'Cambodia', 'cm': 'Cameroon', 
            'ca': 'Canada', 'cv': 'Cape Verde', 'ky': 'Cayman Islands', 'cf': 'Central African Republic', 'td': 'Chad', 
            'cl': 'Chile', 'cn': 'China', 'cx': 'Christmas Island', 'cc': 'Cocos Islands', 'co': 'Colombia', 
            'km': 'Comoros', 'ck': 'Cook Islands', 'cr': 'Costa Rica', 'hr': 'Croatia', 'cu': 'Cuba', 'cw': 'Curacao', 
            'cy': 'Cyprus', 'cz': 'Czech Republic', 'cd': 'Democratic Republic of the Congo', 'dk': 'Denmark', 
            'dj': 'Djibouti', 'dm': 'Dominica', 'do': 'Dominican Republic', 'tl': 'East Timor', 'ec': 'Ecuador', 
            'eg': 'Egypt', 'sv': 'El Salvador', 'gq': 'Equatorial Guinea', 'er': 'Eritrea', 'ee': 'Estonia', 
            'et': 'Ethiopia', 'fk': 'Falkland Islands', 'fo': 'Faroe Islands', 'fj': 'Fiji', 'fi': 'Finland', 
            'fr': 'France', 'pf': 'French Polynesia', 'ga': 'Gabon', 'gm': 'Gambia', 'ge': 'Georgia', 'de': 'Germany', 
            'gh': 'Ghana', 'gi': 'Gibraltar', 'gr': 'Greece', 'gl': 'Greenland', 'gd': 'Grenada', 'gu': 'Guam', 
            'gt': 'Guatemala', 'gg': 'Guernsey', 'gn': 'Guinea', 'gw': 'Guinea-Bissau', 'gy': 'Guyana', 'ht': 'Haiti', 
            'hn': 'Honduras', 'hk': 'Hong Kong', 'hu': 'Hungary', 'is': 'Iceland', 'in': 'India', 'id': 'Indonesia', 
            'ir': 'Iran', 'iq': 'Iraq', 'ie': 'Ireland', 'im': 'Isle of Man', 'il': 'Israel', 'it': 'Italy', 
            'ci': 'Ivory Coast', 'jm': 'Jamaica', 'jp': 'Japan', 'je': 'Jersey', 'jo': 'Jordan', 'kz': 'Kazakhstan', 
            'ke': 'Kenya', 'ki': 'Kiribati', 'xk': 'Kosovo', 'kw': 'Kuwait', 'kg': 'Kyrgyzstan', 'la': 'Laos', 
            'lv': 'Latvia', 'lb': 'Lebanon', 'ls': 'Lesotho', 'lr': 'Liberia', 'ly': 'Libya', 'li': 'Liechtenstein', 
            'lt': 'Lithuania', 'lu': 'Luxembourg', 'mo': 'Macau', 'mk': 'Macedonia', 'mg': 'Madagascar', 
            'mw': 'Malawi', 'my': 'Malaysia', 'mv': 'Maldives', 'ml': 'Mali', 'mt': 'Malta', 'mh': 'Marshall Islands', 
            'mr': 'Mauritania', 'mu': 'Mauritius', 'yt': 'Mayotte', 'mx': 'Mexico', 'fm': 'Micronesia', 'md': 'Moldova', 
            'mc': 'Monaco', 'mn': 'Mongolia', 'me': 'Montenegro', 'ms': 'Montserrat', 'ma': 'Morocco', 'mz': 'Mozambique', 
            'mm': 'Myanmar', 'na': 'Namibia', 'nr': 'Nauru', 'np': 'Nepal', 'nl': 'Netherlands', 'an': 'Netherlands Antilles', 
            'nc': 'New Caledonia', 'nz': 'New Zealand', 'ni': 'Nicaragua', 'ne': 'Niger', 'ng': 'Nigeria', 'nu': 'Niue', 
            'kp': 'North Korea', 'mp': 'Northern Mariana Islands', 'no': 'Norway', 'om': 'Oman', 'pk': 'Pakistan', 
            'pw': 'Palau', 'ps': 'Palestine', 'pa': 'Panama', 'pg': 'Papua New Guinea', 'py': 'Paraguay', 'pe': 'Peru', 
            'ph': 'Philippines', 'pn': 'Pitcairn', 'pl': 'Poland', 'pt': 'Portugal', 'pr': 'Puerto Rico', 'qa': 'Qatar', 
            'cg': 'Republic of the Congo', 're': 'Reunion', 'ro': 'Romania', 'ru': 'Russia', 'rw': 'Rwanda', 
            'bl': 'Saint Barthelemy', 'sh': 'Saint Helena', 'kn': 'Saint Kitts and Nevis', 'lc': 'Saint Lucia', 
            'mf': 'Saint Martin', 'pm': 'Saint Pierre and Miquelon', 'vc': 'Saint Vincent and the Grenadines', 
            'ws': 'Samoa', 'sm': 'San Marino', 'st': 'Sao Tome and Principe', 'sa': 'Saudi Arabia', 'sn': 'Senegal', 
            'rs': 'Serbia', 'sc': 'Seychelles', 'sl': 'Sierra Leone', 'sg': 'Singapore', 'sx': 'Sint Maarten', 
            'sk': 'Slovakia', 'si': 'Slovenia', 'sb': 'Solomon Islands', 'so': 'Somalia', 'za': 'South Africa', 
            'kr': 'South Korea', 'ss': 'South Sudan', 'es': 'Spain', 'lk': 'Sri Lanka', 'sd': 'Sudan', 'sr': 'Suriname', 
            'sj': 'Svalbard and Jan Mayen', 'sz': 'Swaziland', 'se': 'Sweden', 'ch': 'Switzerland', 'sy': 'Syria', 
            'tw': 'Taiwan', 'tj': 'Tajikistan', 'tz': 'Tanzania', 'th': 'Thailand', 'tg': 'Togo', 'tk': 'Tokelau', 
            'to': 'Tonga', 'tt': 'Trinidad and Tobago', 'tn': 'Tunisia', 'tr': 'Turkey', 'tm': 'Turkmenistan', 
            'tc': 'Turks and Caicos Islands', 'tv': 'Tuvalu', 'vi': 'U.S. Virgin Islands', 'ug': 'Uganda', 
            'ua': 'Ukraine', 'ae': 'United Arab Emirates', 'gb': 'United Kingdom', 'us': 'United States', 
            'uy': 'Uruguay', 'uz': 'Uzbekistan', 'vu': 'Vanuatu', 'va': 'Vatican', 've': 'Venezuela', 'vn': 'Vietnam', 
            'wf': 'Wallis and Futuna', 'eh': 'Western Sahara', 'ye': 'Yemen', 'zm': 'Zambia', 'zw': 'Zimbabwe',
            'other': 'Other Country'
        };

        // Language codes for translation (expanded for requested languages)
        const languageCodes = {
            'af': 'af', 'al': 'sq', 'dz': 'ar', 'as': 'en', 'ad': 'ca', 'ao': 'pt', 'ai': 'en', 'aq': 'en', 
            'ag': 'en', 'ar': 'es', 'am': 'hy', 'aw': 'nl', 'au': 'en', 'at': 'de', 'az': 'az', 'bs': 'bs', 
            'bh': 'ar', 'bd': 'bn', 'bb': 'en', 'by': 'be', 'be': 'nl', 'bz': 'en', 'bj': 'fr', 'bm': 'en', 
            'bt': 'dz', 'bo': 'es', 'ba': 'bs', 'bw': 'en', 'br': 'pt', 'io': 'en', 'vg': 'en', 'bn': 'ms', 
            'bg': 'bg', 'bf': 'fr', 'bi': 'fr', 'kh': 'km', 'cm': 'fr', 'ca': 'en', 'cv': 'pt', 'ky': 'en', 
            'cf': 'fr', 'td': 'fr', 'cl': 'es', 'cn': 'zh', 'cx': 'en', 'cc': 'en', 'co': 'es', 'km': 'ar', 
            'ck': 'en', 'cr': 'es', 'hr': 'hr', 'cu': 'es', 'cw': 'nl', 'cy': 'el', 'cz': 'cs', 'cd': 'fr', 
            'dk': 'da', 'dj': 'fr', 'dm': 'en', 'do': 'es', 'tl': 'pt', 'ec': 'es', 'eg': 'ar', 'sv': 'es', 
            'gq': 'es', 'er': 'ti', 'ee': 'et', 'et': 'am', 'fk': 'en', 'fo': 'fo', 'fj': 'en', 'fi': 'fi', 
            'fr': 'fr', 'pf': 'fr', 'ga': 'fr', 'gm': 'en', 'ge': 'ka', 'de': 'de', 'gh': 'en', 'gi': 'en', 
            'gr': 'el', 'gl': 'kl', 'gd': 'en', 'gu': 'en', 'gt': 'es', 'gg': 'en', 'gn': 'fr', 'gw': 'pt', 
            'gy': 'en', 'ht': 'fr', 'hn': 'es', 'hk': 'zh', 'hu': 'hu', 'is': 'is', 'in': 'hi', 'id': 'id', 
            'ir': 'fa', 'iq': 'ar', 'ie': 'en', 'im': 'en', 'il': 'he', 'it': 'it', 'ci': 'fr', 'jm': 'en', 
            'jp': 'ja', 'je': 'en', 'jo': 'ar', 'kz': 'kk', 'ke': 'sw', 'ki': 'en', 'xk': 'sq', 'kw': 'ar', 
            'kg': 'ky', 'la': 'lo', 'lv': 'lv', 'lb': 'ar', 'ls': 'en', 'lr': 'en', 'ly': 'ar', 'li': 'de', 
            'lt': 'lt', 'lu': 'lb', 'mo': 'zh', 'mk': 'mk', 'mg': 'mg', 'mw': 'en', 'my': 'ms', 'mv': 'dv', 
            'ml': 'fr', 'mt': 'mt', 'mh': 'en', 'mr': 'ar', 'mu': 'en', 'yt': 'fr', 'mx': 'es', 'fm': 'en', 
            'md': 'ro', 'mc': 'fr', 'mn': 'mn', 'me': 'sr', 'ms': 'en', 'ma': 'ar', 'mz': 'pt', 'mm': 'my', 
            'na': 'en', 'nr': 'na', 'np': 'ne', 'nl': 'nl', 'an': 'nl', 'nc': 'fr', 'nz': 'en', 'ni': 'es', 
            'ne': 'fr', 'ng': 'en', 'nu': 'niu', 'kp': 'ko', 'mp': 'en', 'no': 'no', 'om': 'ar', 'pk': 'ur', 
            'pw': 'en', 'ps': 'ar', 'pa': 'es', 'pg': 'en', 'py': 'es', 'pe': 'es', 'ph': 'tl', 'pn': 'en', 
            'pl': 'pl', 'pt': 'pt', 'pr': 'es', 'qa': 'ar', 'cg': 'fr', 're': 'fr', 'ro': 'ro', 'ru': 'ru', 
            'rw': 'rw', 'bl': 'fr', 'sh': 'en', 'kn': 'en', 'lc': 'en', 'mf': 'fr', 'pm': 'fr', 'vc': 'en', 
            'ws': 'sm', 'sm': 'it', 'st': 'pt', 'sa': 'ar', 'sn': 'fr', 'rs': 'sr', 'sc': 'en', 'sl': 'en', 
            'sg': 'en', 'sx': 'nl', 'sk': 'sk', 'si': 'sl', 'sb': 'en', 'so': 'so', 'za': 'af', 'kr': 'ko', 
            'ss': 'en', 'es': 'es', 'lk': 'si', 'sd': 'ar', 'sr': 'nl', 'sj': 'no', 'sz': 'en', 'se': 'sv', 
            'ch': 'de', 'sy': 'ar', 'tw': 'zh', 'tj': 'tg', 'tz': 'sw', 'th': 'th', 'tg': 'fr', 'tk': 'tk', 
            'to': 'to', 'tt': 'en', 'tn': 'ar', 'tr': 'tr', 'tm': 'tk', 'tc': 'en', 'tv': 'en', 'vi': 'en', 
            'ug': 'en', 'ua': 'uk', 'ae': 'ar', 'gb': 'en', 'us': 'en', 'uy': 'es', 'uz': 'uz', 'vu': 'bi', 
            'va': 'la', 've': 'es', 'vn': 'vi', 'wf': 'fr', 'eh': 'ar', 'ye': 'ar', 'zm': 'en', 'zw': 'en',
            'other': 'en'
        };

        // Default avatar URL
        const defaultAvatar = 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';

        // Translation dictionaries for our 7 target languages
        const translations = {
            'es': { // Spanish
                'hello': 'hola',
                'goodbye': 'adiÃ³s',
                'thank you': 'gracias',
                'how are you': 'cÃ³mo estÃ¡s',
                'yes': 'sÃ­',
                'no': 'no',
                'please': 'por favor'
            },
            'ru': { // Russian
                'hello': 'Ð¿Ñ€Ð¸Ð²ÐµÑ‚',
                'goodbye': 'Ð´Ð¾ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ñ',
                'thank you': 'ÑÐ¿Ð°ÑÐ¸Ð±Ð¾',
                'how are you': 'ÐºÐ°Ðº Ð´ÐµÐ»Ð°',
                'yes': 'Ð´Ð°',
                'no': 'Ð½ÐµÑ‚',
                'please': 'Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°'
            },
            'zh': { // Mandarin
                'hello': 'ä½ å¥½',
                'goodbye': 'å†è§',
                'thank you': 'è°¢è°¢',
                'how are you': 'ä½ å¥½å—',
                'yes': 'æ˜¯',
                'no': 'ä¸',
                'please': 'è¯·'
            },
            'ar': { // Arabic
                'hello': 'Ù…Ø±Ø­Ø¨Ø§',
                'goodbye': 'Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©',
                'thank you': 'Ø´ÙƒØ±Ø§',
                'how are you': 'ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ',
                'yes': 'Ù†Ø¹Ù…',
                'no': 'Ù„Ø§',
                'please': 'Ù…Ù† ÙØ¶Ù„Ùƒ'
            },
            'pt': { // Portuguese
                'hello': 'olÃ¡',
                'goodbye': 'adeus',
                'thank you': 'obrigado',
                'how are you': 'como vocÃª estÃ¡',
                'yes': 'sim',
                'no': 'nÃ£o',
                'please': 'por favor'
            },
            'it': { // Italian
                'hello': 'ciao',
                'goodbye': 'arrivederci',
                'thank you': 'grazie',
                'how are you': 'come stai',
                'yes': 'sÃ¬',
                'no': 'no',
                'please': 'per favore'
            },
            'ja': { // Japanese
                'hello': 'ã“ã‚“ã«ã¡ã¯',
                'goodbye': 'ã•ã‚ˆã†ãªã‚‰',
                'thank you': 'ã‚ã‚ŠãŒã¨ã†',
                'how are you': 'ãŠå…ƒæ°—ã§ã™ã‹',
                'yes': 'ã¯ã„',
                'no': 'ã„ã„ãˆ',
                'please': 'ãŠé¡˜ã„ã—ã¾ã™'
            },
            'vi': { // Vietnamese
                'hello': 'xin chÃ o',
                'goodbye': 'táº¡m biá»‡t',
                'thank you': 'cáº£m Æ¡n',
                'how are you': 'báº¡n khá»e khÃ´ng',
                'yes': 'cÃ³',
                'no': 'khÃ´ng',
                'please': 'xin vui lÃ²ng'
            },
            'th': { // Thai
                'hello': 'à¸ªà¸§à¸±à¸ªà¸”à¸µ',
                'goodbye': 'à¸¥à¸²à¸à¹ˆà¸­à¸™',
                'thank you': 'à¸‚à¸­à¸šà¸„à¸¸à¸“',
                'how are you': 'à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£',
                'yes': 'à¹ƒà¸Šà¹ˆ',
                'no': 'à¹„à¸¡à¹ˆ',
                'please': 'à¹‚à¸›à¸£à¸”'
            }
        };

        // Generate unique device ID
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }

        // Toggle between login and register forms
        showRegister.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        showLogin.addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Handle avatar upload for registration
        registerAvatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size should be less than 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    registerAvatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
                selectedAvatarFile = file;
            }
        });

        // Handle avatar upload for profile
        profileAvatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size should be less than 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    profileAvatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
                selectedAvatarFile = file;
            }
        });

        // Upload image to Firebase Storage and return URL
        async function uploadImage(file, userId) {
            if (!file) return null;
            
            try {
                const storageRef = storage.ref(`profile_images/${userId}/${file.name}`);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                return null;
            }
        }

        // Register new user
        registerBtn.addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const country = document.getElementById('register-country').value;
            const description = document.getElementById('register-description').value;

            if (!email || !password || !username || !country) {
                alert('Please fill all required fields');
                return;
            }

            try {
                // Check if device already has an account
                const deviceSnapshot = await database.ref('devices/' + deviceId).once('value');
                if (deviceSnapshot.exists()) {
                    throw new Error('This device already has an account. Only one account per device is allowed.');
                }
                
                // Create user with email and password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Upload profile image if selected
                let avatarUrl = defaultAvatar;
                if (selectedAvatarFile) {
                    avatarUrl = await uploadImage(selectedAvatarFile, user.uid);
                }
                
                // Save user data to database
                await Promise.all([
                    database.ref('users/' + user.uid).set({
                        username: username,
                        email: email,
                        country: country,
                        description: description || '',
                        avatar: avatarUrl,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        status: 'online',
                        deviceId: deviceId,
                        language: languageCodes[country] || 'en' // Set user's language based on country
                    }),
                    database.ref('devices/' + deviceId).set({
                        userId: user.uid,
                        registeredAt: firebase.database.ServerValue.TIMESTAMP
                    })
                ]);
                
                alert('Registration successful! Please login.');
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-username').value = '';
                document.getElementById('register-country').value = '';
                document.getElementById('register-description').value = '';
                registerAvatarPreview.src = '';
                selectedAvatarFile = null;
            } catch (error) {
                alert(error.message);
            }
        });

        // Login user
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Check if user is banned
                const banSnapshot = await database.ref('bans/' + currentUser.uid).once('value');
                if (banSnapshot.exists()) {
                    const banData = banSnapshot.val();
                    if (banData.permanent || banData.until > Date.now()) {
                        const banReason = banData.reason || 'Violation of community guidelines';
                        const banMessage = banData.permanent 
                            ? `Your account has been permanently banned. Reason: ${banReason}`
                            : `Your account has been temporarily banned until ${new Date(banData.until).toLocaleString()}. Reason: ${banReason}`;
                        await auth.signOut();
                        throw new Error(banMessage);
                    } else {
                        // Remove expired ban
                        await database.ref('bans/' + currentUser.uid).remove();
                    }
                }
                
                // Verify device ID
                const userSnapshot = await database.ref('users/' + currentUser.uid + '/deviceId').once('value');
                const userDeviceId = userSnapshot.val();
                
                if (userDeviceId !== deviceId) {
                    await auth.signOut();
                    throw new Error('This account is registered on a different device. Only one device per account is allowed.');
                }
                
                // Check if user is admin
                isAdmin = adminEmails.includes(currentUser.email);
                
                // Update user status to online
                await database.ref('users/' + currentUser.uid).update({
                    status: 'online',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Switch to chat interface
                authContainer.classList.remove('active');
                chatContainer.classList.add('active');
                
                // Load users and messages
                loadUsers();
                setupPresence();
                setupMessageManagementListeners();
                updateFollowingCount();
                
                // Set target language based on user's country
                const userCountry = await database.ref('users/' + currentUser.uid + '/country').once('value');
                if (userCountry.exists()) {
                    targetLanguage = languageCodes[userCountry.val()] || 'en';
                }
            } catch (error) {
                alert(error.message);
            }
        });

        // Logout user
        logoutBtn.addEventListener('click', async () => {
            try {
                // Update user status to offline before signing out
                if (currentUser) {
                    await database.ref('users/' + currentUser.uid).update({
                        status: 'offline',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // Remove all listeners
                for (const listenerId in messageListeners) {
                    database.ref('messages').off('child_added', messageListeners[listenerId]);
                }
                messageListeners = {};
                
                for (const listenerId in userListeners) {
                    database.ref('users/' + listenerId).off('value', userListeners[listenerId]);
                }
                userListeners = {};
                
                for (const listenerId in followListeners) {
                    database.ref('follows/' + currentUser.uid + '/' + listenerId).off('value', followListeners[listenerId]);
                }
                followListeners = {};
                
                // Remove message management listeners
                if (allMessagesListener) {
                    database.ref('messages').off('child_added', allMessagesListener);
                    database.ref('messages').off('child_changed', allMessagesListener);
                    allMessagesListener = null;
                }
                
                if (unreadMessagesListener) {
                    database.ref('messages').off('child_added', unreadMessagesListener);
                    database.ref('messages').off('child_changed', unreadMessagesListener);
                    unreadMessagesListener = null;
                }
                
                if (followingListener) {
                    database.ref('follows/' + currentUser.uid).off('value', followingListener);
                    followingListener = null;
                }
                
                await auth.signOut();
                
                chatContainer.classList.remove('active');
                profileContainer.classList.remove('active');
                messagesContainer.classList.remove('active');
                authContainer.classList.add('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                currentUser = null;
                chatMessagesContainer.innerHTML = '';
                usersList.innerHTML = '';
                profileView.style.display = 'none';
                unreadMessages = {};
                selectedAvatarFile = null;
                translateEnabled = false;
                translateBtn.textContent = 'Translate';
                isAdmin = false;
            } catch (error) {
                alert('Error during logout: ' + error.message);
            }
        });

        // Show profile edit form
        profileBtn.addEventListener('click', async () => {
            chatContainer.classList.remove('active');
            messagesContainer.classList.remove('active');
            profileContainer.classList.add('active');
            
            try {
                // Load current profile data
                const snapshot = await database.ref('users/' + currentUser.uid).once('value');
                const user = snapshot.val();
                
                document.getElementById('profile-username').value = user.username;
                document.getElementById('profile-country').value = user.country || '';
                document.getElementById('profile-description').value = user.description || '';
                profileAvatarPreview.src = user.avatar || defaultAvatar;
                
                // Disable username and country fields
                document.getElementById('profile-username').classList.add('readonly-field');
                document.getElementById('profile-username').readOnly = true;
                document.getElementById('profile-country').disabled = true;
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        });

        // Show messages management
        messagesBtn.addEventListener('click', () => {
            chatContainer.classList.remove('active');
            profileContainer.classList.remove('active');
            messagesContainer.classList.add('active');
        });

        // Back to chat from messages management
        backToChatBtn.addEventListener('click', () => {
            messagesContainer.classList.remove('active');
            profileContainer.classList.remove('active');
            chatContainer.classList.add('active');
        });

        // Switch between message tabs
        messageTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                messageTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.messages-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show selected tab content
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-messages-tab`).style.display = 'block';
            });
        });

        // Save profile
        saveProfileBtn.addEventListener('click', async () => {
            const description = document.getElementById('profile-description').value;
            
            try {
                let avatarUrl = profileAvatarPreview.src;
                
                // Upload new image if selected
                if (selectedAvatarFile) {
                    avatarUrl = await uploadImage(selectedAvatarFile, currentUser.uid);
                }
                
                // Update profile in database
                await database.ref('users/' + currentUser.uid).update({
                    description: description || '',
                    avatar: avatarUrl
                });
                
                profileContainer.classList.remove('active');
                chatContainer.classList.add('active');
                loadUsers(); // Refresh user list
                
                // Update profile view if viewing own profile
                if (currentChatWith === currentUser.uid) {
                    showUserProfile(currentUser.uid);
                }
                
                selectedAvatarFile = null;
            } catch (error) {
                alert('Error saving profile: ' + error.message);
            }
        });

        // Cancel profile edit
        cancelProfileBtn.addEventListener('click', () => {
            profileContainer.classList.remove('active');
            chatContainer.classList.add('active');
            selectedAvatarFile = null;
        });

        document.getElementById('theme-select').addEventListener('change', (e) => {
            const theme = e.target.value;
            document.body.className = `theme-${theme}`;
        });

        const userSearchInput = document.getElementById('user-search-input');
        const countryFilterSelect = document.getElementById('country-filter-select');

        userSearchInput.addEventListener('input', () => {
            loadUsers({ username: userSearchInput.value, country: countryFilterSelect.value });
        });

        countryFilterSelect.addEventListener('change', () => {
            loadUsers({ username: userSearchInput.value, country: countryFilterSelect.value });
        });

        function populateCountryFilter() {
            for (const code in countryNames) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = countryNames[code];
                countryFilterSelect.appendChild(option);
            }
        }

        // Setup presence tracking
        function setupPresence() {
            const userStatusDatabaseRef = database.ref('users/' + currentUser.uid);
            
            // Set user to online when connected
            userStatusDatabaseRef.update({
                status: 'online',
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Set user to offline when disconnected
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    return;
                }
                
                userStatusDatabaseRef.onDisconnect().update({
                    status: 'offline',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            });
        }

        // Setup real-time listeners for message management
        function setupMessageManagementListeners() {
            // All messages listener
            allMessagesListener = database.ref('messages')
                .orderByChild('conversationId')
                .startAt(getConversationId(currentUser.uid, ''))
                .endAt(getConversationId(currentUser.uid, '~'))
                .on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    addMessageToAllMessagesTable(message, snapshot.key);
                });
            
            // Unread messages listener
            unreadMessagesListener = database.ref('messages')
                .orderByChild('receiverId')
                .equalTo(currentUser.uid)
                .on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    if (!message.read) {
                        addMessageToUnreadMessagesTable(message, snapshot.key);
                    }
                });
            
            // Following listener
            followingListener = database.ref('follows/' + currentUser.uid)
                .on('child_added', (snapshot) => {
                    const userId = snapshot.key;
                    addUserToFollowingTable(userId);
                });
        }

        // Load all users sorted by online status
        function loadUsers(filter = {}) {
            database.ref('users').on('value', (snapshot) => {
                usersList.innerHTML = '';
                const users = snapshot.val();
                let usersArray = [];
                
                for (const userId in users) {
                    if (userId === currentUser.uid) continue; // Skip current user
                    usersArray.push({ id: userId, ...users[userId] });
                }

                if (filter.username) {
                    usersArray = usersArray.filter(user => user.username.toLowerCase().includes(filter.username.toLowerCase()));
                }
                if (filter.country) {
                    usersArray = usersArray.filter(user => user.country === filter.country);
                }
                
                // Sort users: online first, then by last seen (newest first)
                usersArray.sort((a, b) => {
                    if (a.status === 'online' && b.status !== 'online') return -1;
                    if (a.status !== 'online' && b.status === 'online') return 1;
                    return (b.lastSeen || 0) - (a.lastSeen || 0);
                });
                
                usersArray.forEach(user => {
                    const userItem = document.createElement('li');
                    userItem.className = 'user-item';
                    
                    // Check if user is blocked
                    database.ref('blocks/' + currentUser.uid + '/' + user.id).once('value')
                        .then((blockSnapshot) => {
                            if (blockSnapshot.exists()) {
                                userItem.innerHTML = `
                                    <div class="user-status offline"></div>
                                    <img class="user-avatar" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                    <div class="user-info">
                                        <div class="user-name">${user.username} (Blocked)</div>
                                        <div class="user-country">
                                            <span class="country-flag">${countryFlags[user.country] || 'ðŸŒ'}</span>
                                            ${countryNames[user.country] || 'Other Country'}
                                        </div>
                                    </div>
                                    <div class="last-seen">${formatLastSeen(user.lastSeen)}</div>
                                    <div class="user-actions">
                                        <button class="action-btn delete-btn" data-userid="${user.id}">Ã—</button>
                                    </div>
                                `;
                                userItem.style.opacity = '0.6';
                            } else {
                                // Check if user is banned
                                database.ref('bans/' + user.id).once('value')
                                    .then((banSnapshot) => {
                                        const isBanned = banSnapshot.exists();
                                        const banData = banSnapshot.val();
                                        const isPermanentlyBanned = isBanned && banData.permanent;
                                        const isTemporarilyBanned = isBanned && !banData.permanent && banData.until > Date.now();
                                        
                                        // Check if user is followed
                                        database.ref('follows/' + currentUser.uid + '/' + user.id).once('value')
                                            .then((followSnapshot) => {
                                                const isFollowing = followSnapshot.exists();
                                                
                                                // Get follower count
                                                database.ref('follows/' + user.id).once('value')
                                                    .then((followersSnapshot) => {
                                                        const followersCount = followersSnapshot.numChildren();
                                                        
                                                        userItem.innerHTML = `
                                                            <div class="user-status ${user.status === 'online' && !isBanned ? 'online' : 'offline'}"></div>
                                                            <img class="user-avatar" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                                            <div class="user-info">
                                                                <div class="user-name">${user.username}${isBanned ? (isPermanentlyBanned ? ' (Permanently Banned)' : ' (Temporarily Banned)') : ''}</div>
                                                                <div class="user-country">
                                                                    <span class="country-flag">${countryFlags[user.country] || 'ðŸŒ'}</span>
                                                                    ${countryNames[user.country] || 'Other Country'}
                                                                </div>
                                                                <div class="follower-count">${followersCount} follower${followersCount !== 1 ? 's' : ''}</div>
                                                            </div>
                                                            <div class="last-seen">${formatLastSeen(user.lastSeen)}</div>
                                                            <div class="user-actions">
                                                                <button class="action-btn block-btn" data-userid="${user.id}">B</button>
                                                                <button class="action-btn ${isFollowing ? 'unfollow-btn' : 'follow-btn'}" data-userid="${user.id}">${isFollowing ? 'Ã—' : '+'}</button>
                                                            </div>
                                                        `;
                                                        
                                                        // Add event listeners to action buttons
                                                        const blockBtn = userItem.querySelector('.block-btn');
                                                        if (blockBtn) {
                                                            blockBtn.addEventListener('click', (e) => {
                                                                e.stopPropagation();
                                                                blockUser(user.id);
                                                            });
                                                        }
                                                        
                                                        const followBtn = userItem.querySelector('.follow-btn, .unfollow-btn');
                                                        if (followBtn) {
                                                            followBtn.addEventListener('click', (e) => {
                                                                e.stopPropagation();
                                                                if (followBtn.classList.contains('follow-btn')) {
                                                                    followUser(user.id);
                                                                } else {
                                                                    unfollowUser(user.id);
                                                                }
                                                            });
                                                        }
                                                    });
                                            });
                                    });
                            }
                            
                            userItem.addEventListener('click', () => {
                                // Remove active class from all users
                                document.querySelectorAll('.user-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                // Add active class to selected user
                                userItem.classList.add('active');
                                
                                // Show profile and messages
                                showUserProfile(user.id);
                                loadMessages(user.id);
                            });
                            
                            usersList.appendChild(userItem);
                        });
                });
            });
        }

        // Show user profile
        function showUserProfile(userId) {
            // Remove previous listener if exists
            if (userListeners[userId]) {
                database.ref('users/' + userId).off('value', userListeners[userId]);
            }
            
            // Add new listener for real-time updates
            userListeners[userId] = database.ref('users/' + userId).on('value', (snapshot) => {
                const user = snapshot.val();
                if (!user) return;
                
                viewProfileName.textContent = user.username;
                viewProfileAvatar.src = user.avatar || defaultAvatar;
                viewProfileCountry.innerHTML = `
                    <span class="profile-country-flag">${countryFlags[user.country] || 'ðŸŒ'}</span>
                    ${countryNames[user.country] || 'Other Country'}
                `;
                viewProfileDescription.textContent = user.description || 'No description provided';
                
                // Check if user is banned
                database.ref('bans/' + userId).once('value')
                    .then((banSnapshot) => {
                        const isBanned = banSnapshot.exists();
                        const banData = banSnapshot.val();
                        
                        if (isBanned) {
                            if (banData.permanent) {
                                viewProfileStatus.textContent = 'Permanently Banned';
                            } else if (banData.until > Date.now()) {
                                viewProfileStatus.textContent = `Temporarily Banned until ${new Date(banData.until).toLocaleString()}`;
                            } else {
                                viewProfileStatus.textContent = user.status === 'online' ? 'Online' : `Last seen ${formatLastSeen(user.lastSeen)}`;
                            }
                        } else {
                            viewProfileStatus.textContent = user.status === 'online' ? 'Online' : `Last seen ${formatLastSeen(user.lastSeen)}`;
                        }
                    });
                
                // Update follower count
                database.ref('follows/' + userId).once('value')
                    .then((followersSnapshot) => {
                        const count = followersSnapshot.numChildren();
                        followersCount.textContent = count;
                    });
                
                // Check if current user is following this user
                database.ref('follows/' + currentUser.uid + '/' + userId).once('value')
                    .then((followSnapshot) => {
                        if (followSnapshot.exists()) {
                            followBtn.style.display = 'none';
                            unfollowBtn.style.display = 'block';
                            unfollowBtn.onclick = () => unfollowUser(userId);
                        } else {
                            followBtn.style.display = 'block';
                            unfollowBtn.style.display = 'none';
                            followBtn.onclick = () => followUser(userId);
                        }
                    });
                
                // Show admin controls if current user is admin and viewing another user's profile
                if (isAdmin && userId !== currentUser.uid) {
                    adminControls.style.display = 'flex';
                    
                    // Check if user is currently banned
                    database.ref('bans/' + userId).once('value')
                        .then((banSnapshot) => {
                            const isBanned = banSnapshot.exists();
                            const banData = banSnapshot.val();
                            
                            if (isBanned) {
                                if (banData.permanent) {
                                    tempBanBtn.style.display = 'none';
                                    permBanBtn.style.display = 'none';
                                    unbanBtn.style.display = 'block';
                                } else {
                                    tempBanBtn.style.display = 'none';
                                    permBanBtn.style.display = 'block';
                                    unbanBtn.style.display = 'block';
                                }
                            } else {
                                tempBanBtn.style.display = 'block';
                                permBanBtn.style.display = 'block';
                                unbanBtn.style.display = 'none';
                            }
                        });
                    
                    // Set up ban button event listeners
                    tempBanBtn.onclick = () => tempBanUser(userId);
                    permBanBtn.onclick = () => permBanUser(userId);
                    unbanBtn.onclick = () => unbanUser(userId);
                } else {
                    adminControls.style.display = 'none';
                }
                
                profileView.style.display = 'block';
                currentChatWith = userId;
            });
        }

        // Update current user's following count
        function updateFollowingCount() {
            database.ref('follows/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const count = snapshot.numChildren();
                    followingCount.textContent = count;
                });
        }

        // Follow a user
        function followUser(userId) {
            database.ref('follows/' + currentUser.uid + '/' + userId).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                database.ref('users/' + userId + '/followers').transaction(count => (count || 0) + 1);
                // Add real-time listener for follow status
                if (!followListeners[userId]) {
                    followListeners[userId] = database.ref('follows/' + currentUser.uid + '/' + userId).on('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            // User was unfollowed
                            if (currentChatWith === userId) {
                                showUserProfile(userId);
                            }
                        }
                    });
                }
                
                loadUsers(); // Refresh user list
                addUserToFollowingTable(userId); // Add to following list
                updateFollowingCount(); // Update following count
                
                if (currentChatWith === userId) {
                    showUserProfile(userId); // Update profile view
                }
            })
            .catch((error) => {
                alert('Error following user: ' + error.message);
            });
        }

        // Unfollow a user
        function unfollowUser(userId) {
            database.ref('follows/' + currentUser.uid + '/' + userId).remove()
                .then(() => {
                    database.ref('users/' + userId + '/followers').transaction(count => (count || 0) - 1);
                    loadUsers(); // Refresh user list
                    removeUserFromFollowingTable(userId); // Remove from following list
                    updateFollowingCount(); // Update following count
                    
                    if (currentChatWith === userId) {
                        showUserProfile(userId); // Update profile view
                    }
                })
                .catch((error) => {
                    alert('Error unfollowing user: ' + error.message);
                });
        }

        // Block a user
        function blockUser(userId) {
            if (confirm('Are you sure you want to block this user?')) {
                database.ref('blocks/' + currentUser.uid + '/' + userId).set(true)
                    .then(() => {
                        alert('User blocked successfully');
                        loadUsers(); // Refresh user list
                    })
                    .catch((error) => {
                        alert('Error blocking user: ' + error.message);
                    });
            }
        }

        // Delete a user (remove from your contacts)
        function deleteUser(userId) {
            if (confirm('Are you sure you want to remove this user from your contacts?')) {
                // Remove from follows
                database.ref('follows/' + currentUser.uid + '/' + userId).remove()
                    .then(() => {
                        alert('User removed successfully');
                        loadUsers(); // Refresh user list
                        chatMessagesContainer.innerHTML = '';
                        profileView.style.display = 'none';
                    })
                    .catch((error) => {
                        alert('Error removing user: ' + error.message);
                    });
            }
        }

        // Temporary ban a user (7 days)
        function tempBanUser(userId) {
            if (confirm('Temporarily ban this user for 7 days?')) {
                const banUntil = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days from now
                const reason = prompt('Enter reason for temporary ban:', 'Violation of community guidelines');
                
                if (reason !== null) {
                    database.ref('bans/' + userId).set({
                        permanent: false,
                        until: banUntil,
                        reason: reason || 'Violation of community guidelines',
                        bannedBy: currentUser.uid,
                        bannedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        alert('User temporarily banned for 7 days');
                        loadUsers(); // Refresh user list
                        if (currentChatWith === userId) {
                            showUserProfile(userId); // Update profile view
                        }
                    })
                    .catch((error) => {
                        alert('Error banning user: ' + error.message);
                    });
                }
            }
        }

        // Permanently ban a user
        function permBanUser(userId) {
            if (confirm('Permanently ban this user?')) {
                const reason = prompt('Enter reason for permanent ban:', 'Serious violation of community guidelines');
                
                if (reason !== null) {
                    database.ref('bans/' + userId).set({
                        permanent: true,
                        reason: reason || 'Serious violation of community guidelines',
                        bannedBy: currentUser.uid,
                        bannedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        alert('User permanently banned');
                        loadUsers(); // Refresh user list
                        if (currentChatWith === userId) {
                            showUserProfile(userId); // Update profile view
                        }
                    })
                    .catch((error) => {
                        alert('Error banning user: ' + error.message);
                    });
                }
            }
        }

        // Unban a user
        function unbanUser(userId) {
            if (confirm('Unban this user?')) {
                database.ref('bans/' + userId).remove()
                    .then(() => {
                        alert('User unbanned successfully');
                        loadUsers(); // Refresh user list
                        if (currentChatWith === userId) {
                            showUserProfile(userId); // Update profile view
                        }
                    })
                    .catch((error) => {
                        alert('Error unbanning user: ' + error.message);
                    });
            }
        }

        // Format last seen time
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Never';
            
            const now = Date.now();
            const lastSeen = new Date(timestamp);
            const diff = now - timestamp;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                const minutes = Math.floor(diff / 60000);
                return `${minutes} min${minutes !== 1 ? 's' : ''} ago`;
            } else if (diff < 86400000) { // Less than 1 day
                const hours = Math.floor(diff / 3600000);
                return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diff / 86400000);
                return `${days} day${days !== 1 ? 's' : ''} ago`;
            }
        }

        // Format message timestamp for tables
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            return date.toLocaleString([], { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Load messages between current user and selected user
        function loadMessages(otherUserId) {
            chatMessagesContainer.innerHTML = '';
            
            // Remove previous listener if exists
            if (messageListeners[otherUserId]) {
                database.ref('messages').off('child_added', messageListeners[otherUserId]);
            }
            
            // Get messages where current user is either sender or receiver
            const messagesRef = database.ref('messages')
                .orderByChild('conversationId')
                .equalTo(getConversationId(currentUser.uid, otherUserId));
            
            // Add new listener
            messageListeners[otherUserId] = messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
                
                // Mark as read if it's a received message
                if (message.receiverId === currentUser.uid && !message.read) {
                    database.ref('messages/' + snapshot.key).update({ read: true });
                    removeMessageFromUnreadTable(snapshot.key);
                }
            });
        }

        // Display a message in the chat area
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            if (message.receiverId === currentUser.uid && !message.read) {
                messageElement.classList.add('unread');
            }
            
            // Get username and avatar of the sender
            database.ref('users/' + message.senderId).once('value', (snapshot) => {
                const user = snapshot.val();
                const username = user.username;
                const avatar = user.avatar || defaultAvatar;
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <img class="message-avatar" src="${avatar}" alt="${username}">
                        <div class="message-sender">
                            ${message.senderId === currentUser.uid ? 'You' : username}
                        </div>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                        <button class="action-btn translate-message-btn" data-message="${message.content}" data-target-lang="${targetLanguage}">T</button>
                    </div>
                    <div class="message-content">${message.content}</div>
                `;
                
                chatMessagesContainer.appendChild(messageElement);
                scrollToBottom();

                // Add event listener to the translate button
                const translateBtn = messageElement.querySelector('.translate-message-btn');
                translateBtn.addEventListener('click', async (e) => {
                    const button = e.target;
                    const originalText = button.getAttribute('data-message');
                    const targetLang = button.getAttribute('data-target-lang');
                    const translatedText = await translateMessage(originalText, targetLang);
                    messageElement.querySelector('.message-content').textContent = translatedText;
                });
            });
        }

        // Scroll chat messages to bottom
        function scrollToBottom() {
            // Use setTimeout to ensure the DOM has updated
            setTimeout(() => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }, 100);
        }

        // Format message timestamp
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Generate conversation ID for two users
        function getConversationId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        // Add message to all messages table
        function addMessageToAllMessagesTable(message, messageId) {
            // Skip if not part of current user's conversations
            if (!message.conversationId.includes(currentUser.uid)) return;
            
            // Get sender info
            database.ref('users/' + message.senderId).once('value', (userSnapshot) => {
                const user = userSnapshot.val();
                const isCurrentUser = message.senderId === currentUser.uid;
                const isRead = message.read || isCurrentUser;
                
                const existingRow = document.querySelector(`#all-messages-list tr[data-messageid="${messageId}"]`);
                
                if (existingRow) {
                    // Update existing row
                    existingRow.className = isRead ? 'message-row' : 'message-row unread-message';
                    existingRow.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${isCurrentUser ? 'You' : user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td>${isCurrentUser ? 'Sent' : (isRead ? 'Read' : 'Unread')}</td>
                    `;
                } else {
                    // Create new row
                    const row = document.createElement('tr');
                    row.className = isRead ? 'message-row' : 'message-row unread-message';
                    row.dataset.messageid = messageId;
                    row.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${isCurrentUser ? 'You' : user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td>${isCurrentUser ? 'Sent' : (isRead ? 'Read' : 'Unread')}</td>
                    `;
                    
                    row.addEventListener('click', () => {
                        // Open chat with this user
                        const otherUserId = isCurrentUser ? message.receiverId : message.senderId;
                        currentChatWith = otherUserId;
                        
                        // Switch to chat interface
                        messagesContainer.classList.remove('active');
                        chatContainer.classList.add('active');
                        
                        // Load chat with this user
                        showUserProfile(otherUserId);
                        loadMessages(otherUserId);
                    });
                    
                    allMessagesList.appendChild(row);
                }
            });
        }

        // Add message to unread messages table
        function addMessageToUnreadMessagesTable(message, messageId) {
            // Skip if not unread or not for current user
            if (message.read || message.receiverId !== currentUser.uid) return;
            
            // Get sender info
            database.ref('users/' + message.senderId).once('value', (userSnapshot) => {
                const user = userSnapshot.val();
                
                const existingRow = document.querySelector(`#unread-messages-list tr[data-messageid="${messageId}"]`);
                
                if (existingRow) {
                    // Update existing row
                    existingRow.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td><button class="mark-read-btn" data-messageid="${messageId}">Mark as Read</button></td>
                    `;
                } else {
                    // Create new row
                    const row = document.createElement('tr');
                    row.className = 'message-row unread-message';
                    row.dataset.messageid = messageId;
                    row.innerHTML = `
                        <td>
                            <div class="message-user">
                                <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                ${user.username}
                            </div>
                        </td>
                        <td>${message.content}</td>
                        <td>${formatMessageTime(message.timestamp)}</td>
                        <td><button class="mark-read-btn" data-messageid="${messageId}">Mark as Read</button></td>
                    `;
                    
                    row.addEventListener('click', () => {
                        // Open chat with this user
                        currentChatWith = message.senderId;
                        
                        // Switch to chat interface
                        messagesContainer.classList.remove('active');
                        chatContainer.classList.add('active');
                        
                        // Load chat with this user
                        showUserProfile(message.senderId);
                        loadMessages(message.senderId);
                    });
                    
                    // Add event listener to mark as read button
                    const markReadBtn = row.querySelector('.mark-read-btn');
                    markReadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        markMessageAsRead(messageId);
                    });
                    
                    unreadMessagesList.appendChild(row);
                }
            });
        }

        // Remove message from unread table
        function removeMessageFromUnreadTable(messageId) {
            const row = document.querySelector(`#unread-messages-list tr[data-messageid="${messageId}"]`);
            if (row) {
                row.remove();
            }
        }

        // Add user to following table
        function addUserToFollowingTable(userId) {
            // Get user info
            database.ref('users/' + userId).once('value', (userSnapshot) => {
                const user = userSnapshot.val();
                if (!user) return;
                
                // Get follower count
                database.ref('follows/' + userId).once('value', (followersSnapshot) => {
                    const followersCount = followersSnapshot.numChildren();
                    
                    const existingRow = document.querySelector(`#following-list tr[data-userid="${userId}"]`);
                    
                    if (existingRow) {
                        // Update existing row
                        existingRow.innerHTML = `
                            <td>
                                <div class="message-user">
                                    <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                    ${user.username}
                                </div>
                            </td>
                            <td>${user.status === 'online' ? 'Online' : 'Offline'}</td>
                            <td>${followersCount}</td>
                            <td>
                                <button class="unfollow-btn" data-userid="${userId}">Unfollow</button>
                            </td>
                        `;
                    } else {
                        // Create new row
                        const row = document.createElement('tr');
                        row.className = 'message-row';
                        row.dataset.userid = userId;
                        row.innerHTML = `
                            <td>
                                <div class="message-user">
                                    <img class="message-avatar-small" src="${user.avatar || defaultAvatar}" alt="${user.username}">
                                    ${user.username}
                                </div>
                            </td>
                            <td>${user.status === 'online' ? 'Online' : 'Offline'}</td>
                            <td>${followersCount}</td>
                            <td>
                                <button class="unfollow-btn" data-userid="${userId}">Unfollow</button>
                            </td>
                        `;
                        
                        // Add event listener to unfollow button
                        const unfollowBtn = row.querySelector('.unfollow-btn');
                        unfollowBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            unfollowUser(userId);
                        });
                        
                        row.addEventListener('click', () => {
                            // Open chat with this user
                            currentChatWith = userId;
                            
                            // Switch to chat interface
                            messagesContainer.classList.remove('active');
                            chatContainer.classList.add('active');
                            
                            // Load chat with this user
                            showUserProfile(userId);
                            loadMessages(userId);
                        });
                        
                        followingList.appendChild(row);
                    }
                });
            });
        }

        // Remove user from following table
        function removeUserFromFollowingTable(userId) {
            const row = document.querySelector(`#following-list tr[data-userid="${userId}"]`);
            if (row) {
                row.remove();
            }
        }

        // Mark message as read
        function markMessageAsRead(messageId) {
            database.ref('messages/' + messageId).update({ read: true })
                .then(() => {
                    removeMessageFromUnreadTable(messageId);
                })
                .catch((error) => {
                    alert('Error marking message as read: ' + error.message);
                });
        }

        // Translate message using DeepL API
        async function translateMessage(text, targetLang) {
            if (!text || !targetLang || targetLang === 'en') return text;

            const apiKey = '33c2cafafdmsh8fa0dd9b930f308p112f4';
            const url = 'https://deep-translate1.p.rapidapi.com/language/translate/v2';

            const options = {
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                    'X-RapidAPI-Key': apiKey,
                    'X-RapidAPI-Host': 'deep-translate1.p.rapidapi.com'
                },
                body: JSON.stringify({
                    q: text,
                    source: 'en',
                    target: targetLang
                })
            };

            try {
                const response = await fetch(url, options);
                const result = await response.json();
                return `[Translated to ${targetLang}] ${result.data.translations.translatedText}`;
            } catch (error) {
                console.error('Error translating message:', error);
                return text; // Return original text on error
            }
        }

        // Toggle translation
        translateBtn.addEventListener('click', async () => {
            translateEnabled = !translateEnabled;
            
            if (translateEnabled) {
                translateBtn.innerHTML = '<span class="loading-spinner"></span> Translating...';
                
                // Translate all messages in current chat
                if (currentChatWith) {
                    const messages = chatMessagesContainer.querySelectorAll('.message-content');
                    for (const messageElement of messages) {
                        const originalText = messageElement.textContent;
                        const translatedText = await translateMessage(originalText, targetLanguage);
                        messageElement.textContent = translatedText;
                    }
                }
                
                translateBtn.textContent = 'Disable Translate';
            } else {
                // Reload messages to show original text
                if (currentChatWith) {
                    loadMessages(currentChatWith);
                }
                translateBtn.textContent = 'Translate';
            }
        });

        // Banned words list
        const bannedWords = ['rasis', 'bodoh', 'gila'];

        // Check for banned words and ban user if necessary
        async function checkAndBanUser(userId, text) {
            const containsBannedWord = bannedWords.some(word => text.toLowerCase().includes(word));
            if (containsBannedWord) {
                const reason = 'Menggunakan bahasa yang tidak pantas.';
                await database.ref('bans/' + userId).set({
                    permanent: true,
                    reason: reason,
                    bannedBy: 'system',
                    bannedAt: firebase.database.ServerValue.TIMESTAMP
                });
                alert('Akun Anda telah diblokir secara permanen karena menggunakan bahasa yang tidak pantas.');
                logoutBtn.click();
                return true;
            }
            return false;
        }

        // Send message
        async function sendMessage() {
            if (!currentChatWith) {
                alert('Please select a user to chat with');
                return;
            }
            
            const content = messageInput.value.trim();
            if (!content) return;

            // Check for banned words
            const isBanned = await checkAndBanUser(currentUser.uid, content);
            if (isBanned) return;
            
            // Get receiver's language preference for automatic translation
            let receiverLanguage = 'en';
            try {
                const receiverSnapshot = await database.ref('users/' + currentChatWith + '/language').once('value');
                receiverLanguage = receiverSnapshot.val() || 'en';
            } catch (error) {
                console.error('Error getting receiver language:', error);
            }
            
            // If receiver's language is different from sender's, translate automatically
            let finalContent = content;
            if (receiverLanguage !== 'en') {
                finalContent = await translateMessage(content, receiverLanguage);
            }
            
            const message = {
                senderId: currentUser.uid,
                receiverId: currentChatWith,
                content: finalContent,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                conversationId: getConversationId(currentUser.uid, currentChatWith),
                read: false,
                originalLanguage: 'en', // Assuming sender always types in English
                translatedLanguage: receiverLanguage !== 'en' ? receiverLanguage : null
            };
            
            database.ref('messages').push(message)
                .then(() => {
                    messageInput.value = '';
                })
                .catch((error) => {
                    alert('Error sending message: ' + error.message);
                });
        }

        // Send message on button click or Enter key
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Automatically select country based on IP
        async function autoSelectCountry() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const countryCode = data.country_code.toLowerCase();
                const countrySelect = document.getElementById('register-country');
                if (countryCode && countrySelect.querySelector(`option[value="${countryCode}"]`)) {
                    countrySelect.value = countryCode;
                }
            } catch (error) {
                console.error('Error auto-selecting country:', error);
            }
        }

        let localStream;
        let remoteStream;
        let peerConnection;
        const configuration = {
            iceServers: [
                {
                    urls: [
                        'stun:stun1.l.google.com:19302',
                        'stun:stun2.l.google.com:19302',
                    ],
                },
            ],
            iceCandidatePoolSize: 10,
        };

        async function startCall(type) {
            localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
            document.getElementById('local-video').srcObject = localStream;

            peerConnection = new RTCPeerConnection(configuration);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.ontrack = event => {
                remoteStream = event.streams[0];
                document.getElementById('remote-video').srcObject = remoteStream;
            };

            const callDoc = database.ref('calls').doc();
            const offerCandidates = callDoc.collection('offerCandidates');
            const answerCandidates = callDoc.collection('answerCandidates');

            peerConnection.onicecandidate = event => {
                event.candidate && offerCandidates.add(event.candidate.toJSON());
            };

            const offerDescription = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offerDescription);

            const offer = {
                sdp: offerDescription.sdp,
                type: offerDescription.type,
            };

            await callDoc.set({ offer });

            callDoc.onSnapshot(snapshot => {
                const data = snapshot.data();
                if (!peerConnection.currentRemoteDescription && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    peerConnection.setRemoteDescription(answerDescription);
                }
            });

            answerCandidates.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });
        }

        document.getElementById('voice-call-btn').addEventListener('click', () => startCall('voice'));
        document.getElementById('video-call-btn').addEventListener('click', () => startCall('video'));

        leaderboardBtn.addEventListener('click', () => {
            chatContainer.classList.remove('active');
            leaderboardContainer.style.display = 'flex';
            loadLeaderboard();
        });

        backToChatFromLeaderboardBtn.addEventListener('click', () => {
            leaderboardContainer.style.display = 'none';
            chatContainer.classList.add('active');
        });

        async function loadLeaderboard() {
            const usersRef = database.ref('users');
            usersRef.orderByChild('followers').limitToLast(10).on('value', snapshot => {
                const users = [];
                snapshot.forEach(childSnapshot => {
                    users.unshift(childSnapshot.val());
                });
                const leaderboardContent = document.getElementById('leaderboard-content');
                leaderboardContent.innerHTML = '<h3>Top 10 Most Followers</h3>';
                const list = document.createElement('ol');
                users.forEach(user => {
                    const item = document.createElement('li');
                    item.textContent = `${user.username} - ${user.followers || 0} followers`;
                    list.appendChild(item);
                });
                leaderboardContent.appendChild(list);
            });
        }

        function loadRecentChats() {
            const recentChatsRef = database.ref('messages').orderByChild('timestamp').limitToLast(100);
            recentChatsRef.on('value', snapshot => {
                const recentChats = {};
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    if (message.senderId === currentUser.uid) {
                        recentChats[message.receiverId] = message;
                    } else if (message.receiverId === currentUser.uid) {
                        recentChats[message.senderId] = message;
                    }
                });

                const recentChatsContainer = document.getElementById('recent-chats-container');
                recentChatsContainer.innerHTML = '<h3>Recent Chats</h3>';
                const list = document.createElement('ul');
                for (const userId in recentChats) {
                    database.ref('users/' + userId).once('value').then(userSnapshot => {
                        const user = userSnapshot.val();
                        const item = document.createElement('li');
                        item.textContent = user.username;
                        item.addEventListener('click', () => {
                            showUserProfile(userId);
                            loadMessages(userId);
                        });
                        list.appendChild(item);
                    });
                }
                recentChatsContainer.appendChild(list);
            });
        }

        // Check auth state on page load
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                populateCountryFilter();
                try {
                    // Verify device ID
                    const userSnapshot = await database.ref('users/' + user.uid + '/deviceId').once('value');
                    const userDeviceId = userSnapshot.val();
                    
                    if (userDeviceId !== deviceId) {
                        await auth.signOut();
                        throw new Error('This account is registered on a different device. Only one device per account is allowed.');
                    }
                    
                    // Check if user is banned
                    const banSnapshot = await database.ref('bans/' + user.uid).once('value');
                    if (banSnapshot.exists()) {
                        const banData = banSnapshot.val();
                        if (banData.permanent || banData.until > Date.now()) {
                            const banReason = banData.reason || 'Violation of community guidelines';
                            const banMessage = banData.permanent 
                                ? `Your account has been permanently banned. Reason: ${banReason}`
                                : `Your account has been temporarily banned until ${new Date(banData.until).toLocaleString()}. Reason: ${banReason}`;
                            await auth.signOut();
                            throw new Error(banMessage);
                        } else {
                            // Remove expired ban
                            await database.ref('bans/' + user.uid).remove();
                        }
                    }
                    
                    currentUser = user;
                    
                    // Check if user is admin
                    isAdmin = adminEmails.includes(currentUser.email);
                    
                    authContainer.classList.remove('active');
                    chatContainer.classList.add('active');
                    
                    // Update user status to online
                    await database.ref('users/' + currentUser.uid).update({
                        status: 'online',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Load users and setup presence
                    loadUsers();
                    loadRecentChats();
                    setupPresence();
                    setupMessageManagementListeners();
                    updateFollowingCount();
                    
                    // Set target language based on user's country
                    const userCountry = await database.ref('users/' + currentUser.uid + '/country').once('value');
                    if (userCountry.exists()) {
                        targetLanguage = languageCodes[userCountry.val()] || 'en';
                    }
                } catch (error) {
                    alert(error.message);
                    chatContainer.classList.remove('active');
                    messagesContainer.classList.remove('active');
                    authContainer.classList.add('active');
                    loginForm.style.display = 'block';
                }
            } else {
                currentUser = null;
                chatContainer.classList.remove('active');
                profileContainer.classList.remove('active');
                messagesContainer.classList.remove('active');
                authContainer.classList.add('active');
                autoSelectCountry(); // Auto-select country on logout
            }
        });
    </script>
</body>
</html>